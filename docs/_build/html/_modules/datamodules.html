<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datamodules &mdash; fusionlibrary  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/florencestheme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fusionlibrary
              <img src="../_static/computergif.gif" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Table of Contents ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">FuseIt: an introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fusion_model_explanations.html">Fusion Model Explanations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Tutorials ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Tutorials and Examples Gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ API Reference ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.fusion_models.html">fusionlibrary.fusion_models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.datamodules.html">fusionlibrary.datamodules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.train_functions.html">fusionlibrary.train_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.eval_functions.Plotter.html">fusionlibrary.eval_functions.Plotter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.utils.model_chooser.html">fusionlibrary.utils.model_chooser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusionlibrary.utils.pl_utils.html">fusionlibrary.utils.pl_utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fusionlibrary</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">datamodules</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datamodules</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file contains the datamodules for the different modalities and the different</span>
<span class="sd">fusion methods. The datamodules are used to load the data and create the</span>
<span class="sd">dataloader objects for training and validation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torch_geometric.data.lightning</span> <span class="kn">import</span> <span class="n">LightningNodeData</span>

<span class="c1"># from fusionlibrary.eval_functions import plot_graph</span>


<div class="viewcode-block" id="downsample_img_batch"><a class="viewcode-back" href="../source/datamodules.html#datamodules.downsample_img_batch">[docs]</a><span class="k">def</span> <span class="nf">downsample_img_batch</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downsamples a batch of images to a specified size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : array-like</span>
<span class="sd">        Batch of images.</span>
<span class="sd">    output_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width).</span>
<span class="sd">        If None, no downsampling is performed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    downsampled_img : array-like</span>
<span class="sd">        Downsampled image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">imgs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">downsampled_img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">downsampled_img</span><span class="p">)</span></div>


<div class="viewcode-block" id="CustomDataset"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataset">[docs]</a><span class="k">class</span> <span class="nc">CustomDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom dataset class for multimodal data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pred_features : list or tensor</span>
<span class="sd">        List of tensors or tensor of predictive features</span>
<span class="sd">        (i.e. tabular or image data without labels).</span>
<span class="sd">    labels : dataframe</span>
<span class="sd">        Dataframe of labels (column name must be &quot;pred_label&quot;).</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __len__()</span>
<span class="sd">        Returns the length of the dataset.</span>
<span class="sd">    __getitem__(idx)</span>
<span class="sd">        Returns the item at the specified index.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_features</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        pred_features : list or tensor</span>
<span class="sd">            List of tensors or tensor of predictive features</span>
<span class="sd">            (i.e. tabular or image data without labels).</span>
<span class="sd">        labels : dataframe</span>
<span class="sd">            Dataframe of labels (column name must be &quot;pred_label&quot;).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If pred_features is not a list or tensor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if pred_features is a list: it&#39;s multimodal data</span>
        <span class="c1"># only 2 modalities are supported currently</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span> <span class="o">=</span> <span class="n">pred_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset2</span> <span class="o">=</span> <span class="n">pred_features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># if pred_features is a tensor: it&#39;s unimodal data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;pred_features must be a list or a tensor, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pred_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># convert labels to tensor and correct dtype</span>
        <span class="n">label_type</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;int64&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<div class="viewcode-block" id="CustomDataset.__len__"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataset.__len__">[docs]</a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the length of the dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Length of the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomDataset.__getitem__"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataset.__getitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the item at the specified index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            Index of the item to return.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset2</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LoadDatasets"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets">[docs]</a><span class="k">class</span> <span class="nc">LoadDatasets</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for loading the different datasets for the different modalities.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tabular1_source : str</span>
<span class="sd">        Source csv file for tabular1 data.</span>
<span class="sd">    tabular2_source : str</span>
<span class="sd">        Source csv file for tabular2 data.</span>
<span class="sd">    img_source : str</span>
<span class="sd">        Source torch file for image data.</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width, depth).</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    load_tabular1()</span>
<span class="sd">        Loads the tabular1-only dataset.</span>
<span class="sd">    load_tabular2()</span>
<span class="sd">        Loads the tabular2-only dataset.</span>
<span class="sd">    load_img()</span>
<span class="sd">        Loads the image-only dataset.</span>
<span class="sd">    load_both_tabular()</span>
<span class="sd">        Loads the tabular1 and tabular2 multimodal dataset.</span>
<span class="sd">    load_tab_and_img()</span>
<span class="sd">        Loads the tabular1 and image multimodal dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">img_downsample_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">            [tabular1_source, tabular2_source, img_source]</span>
<span class="sd">        img_downsample_dims : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images.</span>
<span class="sd">            None if not downsampling. (default None)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If sources is not a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_source</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">img_downsample_dims</span>  <span class="c1"># can choose own image size here</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LoadDatasets.load_tabular1"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets.load_tabular1">[docs]</a>    <span class="k">def</span> <span class="nf">load_tabular1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>
        <span class="n">tab_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>
        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_tabular2"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets.load_tabular2">[docs]</a>    <span class="k">def</span> <span class="nf">load_tabular2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular2-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tab_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">)</span>
        <span class="n">tab_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>
        <span class="n">mod2_dim</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod2_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_img"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets.load_img">[docs]</a>    <span class="k">def</span> <span class="nf">load_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the image-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_scans</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_source</span><span class="p">)</span>
        <span class="n">all_scans_ds</span> <span class="o">=</span> <span class="n">downsample_img_batch</span><span class="p">(</span><span class="n">all_scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span>

        <span class="c1"># get the labels from the tabular1 dataset</span>
        <span class="n">label_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>
        <span class="n">label_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">label_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">all_scans_ds</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>

        <span class="n">img_dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_scans_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_dim</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_both_tabular"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets.load_both_tabular">[docs]</a>    <span class="k">def</span> <span class="nf">load_both_tabular</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1 and tabular2 multimodal dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">)</span>
        <span class="n">tab2_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">)</span>

        <span class="n">tab1_pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab1_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">tab2_pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab2_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab1_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
            <span class="p">[</span><span class="n">tab1_pred_features</span><span class="p">,</span> <span class="n">tab2_pred_features</span><span class="p">],</span> <span class="n">pred_label</span>
        <span class="p">)</span>

        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">tab1_pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod2_dim</span> <span class="o">=</span> <span class="n">tab2_pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="n">mod2_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_tab_and_img"><a class="viewcode-back" href="../source/datamodules.html#datamodules.LoadDatasets.load_tab_and_img">[docs]</a>    <span class="k">def</span> <span class="nf">load_tab_and_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1 and image multimodal dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tab1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">)</span>
        <span class="n">tab1_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab1_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">label_df</span> <span class="o">=</span> <span class="n">tab1_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_source</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">downsample_img_batch</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">([</span><span class="n">tab1_features</span><span class="p">,</span> <span class="n">imgs</span><span class="p">],</span> <span class="n">label_df</span><span class="p">)</span>
        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">tab1_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">img_dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_dim</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="CustomDataModule"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule">[docs]</a><span class="k">class</span> <span class="nc">CustomDataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files.</span>
<span class="sd">    modality_type : str</span>
<span class="sd">        Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8).</span>
<span class="sd">    subspace_method : class</span>
<span class="sd">        Subspace method class (default None) (only for subspace methods).</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    prepare_data()</span>
<span class="sd">        Loads the data with LoadDatasets class.</span>
<span class="sd">    setup()</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified.</span>
<span class="sd">    train_dataloader()</span>
<span class="sd">        Returns the dataloader for training.</span>
<span class="sd">    val_dataloader()</span>
<span class="sd">        Returns the dataloader for validation.</span>
<span class="sd">    train_eval_dataloader()</span>
<span class="sd">        Returns the dataloader for evaluation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">modality_type</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">subspace_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        modality_type : str</span>
<span class="sd">            Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size (default 8).</span>
<span class="sd">        subspace_method : class</span>
<span class="sd">            Subspace method class (default None) (only for subspace methods).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If modality_type is not one of the following: tabular1, tabular2, img, both_tab,</span>
<span class="sd">            tab_img.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="o">=</span> <span class="n">subspace_method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_latent_dims</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;subspace_latdims&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CustomDataModule.prepare_data"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO add in some evaluation figures of the subspace methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="CustomDataModule.setup"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        train_dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        val_dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        train_eval_dataloader : dataloader</span>
<span class="sd">            Dataloader for evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if subspace method is specified</span>
            <span class="n">subspace_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span>
            <span class="p">)</span>
            <span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">data_dims</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span>
            <span class="p">)</span>

            <span class="c1"># make a new CustomDataset with the latent features</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span></div>

<div class="viewcode-block" id="CustomDataModule.train_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule.train_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for training.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CustomDataModule.val_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule.val_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for validation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CustomDataModule.train_eval_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.CustomDataModule.train_eval_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_eval_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for evaluation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="KFoldDataModule"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule">[docs]</a><span class="k">class</span> <span class="nc">KFoldDataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with k-fold cross</span>
<span class="sd">    validation</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_folds : int</span>
<span class="sd">        Total number of folds.</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files.</span>
<span class="sd">    modality_type : str</span>
<span class="sd">        Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8).</span>
<span class="sd">    subspace_method : class</span>
<span class="sd">        Subspace method class (default None) (only for subspace methods).</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    prepare_data()</span>
<span class="sd">        Loads the data with LoadDatasets class.</span>
<span class="sd">    kfold_split()</span>
<span class="sd">        Splits the dataset into k folds.</span>
<span class="sd">    setup()</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified.</span>
<span class="sd">    train_dataloader()</span>
<span class="sd">        Returns the dataloader for training.</span>
<span class="sd">    val_dataloader()</span>
<span class="sd">        Returns the dataloader for validation.</span>
<span class="sd">    train_eval_dataloader()</span>
<span class="sd">        Returns the dataloader for evaluation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">modality_type</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">subspace_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        modality_type : str</span>
<span class="sd">            Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size (default 8).</span>
<span class="sd">        subspace_method : class</span>
<span class="sd">            Subspace method class (default None) (only for subspace methods).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If modality_type is not one of the following: tabular1, tabular2, img, both_tab,</span>
<span class="sd">            tab_img.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>  <span class="c1"># total number of folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subspace_method</span>  <span class="c1"># subspace method class (only for subspace methods)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_latent_dims</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;subspace_latdims&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="KFoldDataModule.prepare_data"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="KFoldDataModule.kfold_split"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.kfold_split">[docs]</a>    <span class="k">def</span> <span class="nf">kfold_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the dataset into k folds</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        folds : list</span>
<span class="sd">            List of tuples of (train_dataset, test_dataset)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># splits the dataset into k folds</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get the indices of the dataset</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>

        <span class="n">folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="c1"># split the dataset into train and test sets for each fold</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">)</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span>
            <span class="n">folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">folds</span>  <span class="c1"># list of tuples of (train_dataset, test_dataset)</span></div>

<div class="viewcode-block" id="KFoldDataModule.setup"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        train_dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        val_dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        train_eval_dataloader : dataloader</span>
<span class="sd">            Dataloader for evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfold_split</span><span class="p">()</span>  <span class="c1"># get the k folds from kfold_split() function</span>

        <span class="c1"># if subspace method is specified, run the subspace method on each fold</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_folds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">:</span>
                <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">fold</span>
                <span class="n">subspace_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
                <span class="p">)</span>
                <span class="p">(</span>
                    <span class="n">test_latents</span><span class="p">,</span>
                    <span class="n">test_labels</span><span class="p">,</span>
                    <span class="n">data_dims</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

                <span class="c1"># make a new CustomDataset with the latent features</span>
                <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
                <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>

                <span class="n">new_folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">new_folds</span>  <span class="c1"># update the folds with the new train and test datasets</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span>  <span class="c1"># update the data dimensions</span></div>

<div class="viewcode-block" id="KFoldDataModule.train_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.train_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for training.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fold_idx : int</span>
<span class="sd">            Index of the fold to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="KFoldDataModule.val_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.val_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for validation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fold_idx : int</span>
<span class="sd">            Index of the fold to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="KFoldDataModule.train_eval_dataloader"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldDataModule.train_eval_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_eval_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for evaluation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fold_idx : int</span>
<span class="sd">            Index of the fold to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="GraphDataModule"><a class="viewcode-back" href="../source/datamodules.html#datamodules.GraphDataModule">[docs]</a><span class="k">class</span> <span class="nc">GraphDataModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with graph data</span>
<span class="sd">    structure.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files.</span>
<span class="sd">    modality_type : str</span>
<span class="sd">        Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8) (although not used for graph methods).</span>
<span class="sd">    graph_creation_method : class</span>
<span class="sd">        Graph creation method class.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    prepare_data()</span>
<span class="sd">        Loads the data with LoadDatasets class.</span>
<span class="sd">    setup()</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>
<span class="sd">    get_lightning_module()</span>
<span class="sd">        Returns the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">modality_type</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">graph_creation_method</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        modality_type : str</span>
<span class="sd">            Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        graph_creation_method : class</span>
<span class="sd">            Graph creation method class.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size (default 8) (although not used for graph methods).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If modality_type is not one of the following: tabular1, tabular2, img, both_tab,</span>
<span class="sd">            tab_img.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span> <span class="o">=</span> <span class="n">graph_creation_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="GraphDataModule.prepare_data"><a class="viewcode-back" href="../source/datamodules.html#datamodules.GraphDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="GraphDataModule.setup"><a class="viewcode-back" href="../source/datamodules.html#datamodules.GraphDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get random train and test idxs</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">indices</span>

        <span class="c1"># get the graph data structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span></div>

        <span class="c1"># plot and save the graph</span>
        <span class="c1"># TODO move to the soon-to-be-made plotting module? or just remove</span>
        <span class="c1"># plot_graph(self.graph_data, self.params)</span>

<div class="viewcode-block" id="GraphDataModule.get_lightning_module"><a class="viewcode-back" href="../source/datamodules.html#datamodules.GraphDataModule.get_lightning_module">[docs]</a>    <span class="k">def</span> <span class="nf">get_lightning_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        lightning_module : lightning module</span>
<span class="sd">            Lightning module for converting the graph data structure into a pytorch dataloader.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lightning_module</span> <span class="o">=</span> <span class="n">LightningNodeData</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_data</span><span class="p">,</span>
            <span class="n">input_train_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_idxs</span><span class="p">,</span>
            <span class="n">input_val_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">input_test_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">input_pred_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">loader</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lightning_module</span></div></div>


<div class="viewcode-block" id="KFoldGraphDataModule"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldGraphDataModule">[docs]</a><span class="k">class</span> <span class="nc">KFoldGraphDataModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with graph data</span>
<span class="sd">    structure and k-fold cross validation</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_folds : int</span>
<span class="sd">        Total number of folds.</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files.</span>
<span class="sd">    modality_type : str</span>
<span class="sd">        Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8) (although not used for graph methods).</span>
<span class="sd">    graph_creation_method : class</span>
<span class="sd">        Graph creation method class.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    prepare_data()</span>
<span class="sd">        Loads the data with LoadDatasets class.</span>
<span class="sd">    kfold_split()</span>
<span class="sd">        Splits the dataset into k folds.</span>
<span class="sd">    setup()</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>
<span class="sd">    get_lightning_module()</span>
<span class="sd">        Returns the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">modality_type</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">graph_creation_method</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        modality_type : str</span>
<span class="sd">            Type of modality (tabular1, tabular2, img, both_tab, tab_img).</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        graph_creation_method : class</span>
<span class="sd">            Graph creation method class.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size (default 8) (although not used for graph methods).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If modality_type is not one of the following: tabular1, tabular2, img, both_tab,</span>
<span class="sd">            tab_img.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>  <span class="c1"># total number of folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span> <span class="o">=</span> <span class="n">graph_creation_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="KFoldGraphDataModule.prepare_data"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldGraphDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.kfold_split"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldGraphDataModule.kfold_split">[docs]</a>    <span class="k">def</span> <span class="nf">kfold_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the dataset into k folds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># splits the dataset into k folds</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>  <span class="c1"># get the indices of the dataset</span>

        <span class="n">folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="c1"># split the dataset into train and test sets for each fold</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">)</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span>
            <span class="n">folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># list of tuples of (train_dataset, test_dataset)</span>
        <span class="k">return</span> <span class="n">folds</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.setup"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldGraphDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfold_split</span><span class="p">()</span>  <span class="c1"># get the k folds from kfold_split() function</span>

        <span class="n">new_folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">:</span>
            <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">fold</span>

            <span class="n">train_idxs</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">indices</span>  <span class="c1"># get train node idxs from kfold_split()</span>
            <span class="n">test_idxs</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">indices</span>  <span class="c1"># get test node idxs from kfold_split()</span>

            <span class="c1"># get the graph data structure</span>
            <span class="n">graph_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

            <span class="c1"># plot and save the graph?</span>
            <span class="c1"># TODO remove?</span>
            <span class="c1"># plot_graph(graph_data, self.params)</span>

            <span class="n">new_folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">graph_data</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="n">new_folds</span>  <span class="c1"># list of tuples of (graph_data, train_idxs, test_idxs)</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.get_lightning_module"><a class="viewcode-back" href="../source/datamodules.html#datamodules.KFoldGraphDataModule.get_lightning_module">[docs]</a>    <span class="k">def</span> <span class="nf">get_lightning_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        lightning_modules : list</span>
<span class="sd">            List of lightning modules for each fold.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the normal lightning module using the pytorch geometric lightning module</span>

        <span class="n">lightning_modules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">:</span>
            <span class="n">graph_data</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">test_idxs</span> <span class="o">=</span> <span class="n">fold</span>

            <span class="n">lightning_module</span> <span class="o">=</span> <span class="n">LightningNodeData</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">graph_data</span><span class="p">,</span>
                <span class="n">input_train_nodes</span><span class="o">=</span><span class="n">train_idxs</span><span class="p">,</span>
                <span class="n">input_val_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">input_test_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">input_pred_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">loader</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">lightning_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lightning_module</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lightning_modules</span>  <span class="c1"># list of lightning modules for each fold</span></div></div>


<div class="viewcode-block" id="get_data_module"><a class="viewcode-back" href="../source/datamodules.html#datamodules.get_data_module">[docs]</a><span class="k">def</span> <span class="nf">get_data_module</span><span class="p">(</span><span class="n">init_model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># needs model attributes: fusion_type and modality_type</span>
    <span class="c1"># needs params: kfold, pred_type etc</span>

    <span class="n">data_sources</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tabular1_source&quot;</span><span class="p">],</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tabular2_source&quot;</span><span class="p">],</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;img_source&quot;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">init_model</span><span class="o">.</span><span class="n">fusion_type</span> <span class="o">==</span> <span class="s2">&quot;graph&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="n">dmg</span> <span class="o">=</span> <span class="n">KFoldGraphDataModule</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">init_model</span><span class="o">.</span><span class="n">modality_type</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
                <span class="n">graph_creation_method</span><span class="o">=</span><span class="n">init_model</span><span class="o">.</span><span class="n">graph_maker</span><span class="p">,</span>
                <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dmg</span> <span class="o">=</span> <span class="n">GraphDataModule</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">init_model</span><span class="o">.</span><span class="n">modality_type</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
                <span class="n">graph_creation_method</span><span class="o">=</span><span class="n">init_model</span><span class="o">.</span><span class="n">graph_maker</span><span class="p">,</span>
                <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">dmg</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">dmg</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">dmg</span><span class="o">.</span><span class="n">get_lightning_module</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">dm_instance</span> <span class="ow">in</span> <span class="n">dm</span><span class="p">:</span>
                <span class="n">dm_instance</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">dmg</span><span class="o">.</span><span class="n">data_dims</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dm</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">dmg</span><span class="o">.</span><span class="n">data_dims</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># another other than graph fusion</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="n">datamodule_func</span> <span class="o">=</span> <span class="n">KFoldDataModule</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datamodule_func</span> <span class="o">=</span> <span class="n">CustomDataModule</span>

        <span class="n">dm</span> <span class="o">=</span> <span class="n">datamodule_func</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">init_model</span><span class="o">.</span><span class="n">modality_type</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
            <span class="n">subspace_method</span><span class="o">=</span><span class="n">init_model</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dm</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Florence J Townend.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>