<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>eval &mdash; fusilli  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/florencestheme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/pink_pasta_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fusilli
              <img src="../_static/pink_pasta_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Table of Contents ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Fusilli: an introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fusion_model_explanations.html">Fusion Model Explanations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modifying_models.html">Modifying the fusion models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Tutorials ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Tutorials and Examples Gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ API Reference ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.fusion_models.html">fusilli.fusion_models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.data.html">fusilli.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.train.html">fusilli.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.eval.html">fusilli.eval</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.utils.html">fusilli.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fusilli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">eval</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for eval</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains classes and functions for evaluating trained models (i.e. plotting results from training).</span>
<span class="sd">The setup for this module has been inspired by the scikit-learn API for plotting results, which involves each plot</span>
<span class="sd">being a class with a ``from_model`` method that takes in a trained model and returns a plot with the validation data, and a ``from_new_data``</span>
<span class="sd">method that takes in a trained model and new data and returns a plot. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch_geometric</span> <span class="k">as</span> <span class="nn">pyg</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">ConcatDataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="kn">import</span> <span class="nn">fusilli.data</span> <span class="k">as</span> <span class="nn">data</span>
<span class="kn">from</span> <span class="nn">fusilli.fusion_models.base_model</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">fusilli.utils.training_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_checkpoint_filename_for_trained_fusion_model</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="ParentPlotter"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter">[docs]</a><span class="k">class</span> <span class="nc">ParentPlotter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parent class for all plot classes. </span>
<span class="sd">    </span>
<span class="sd">    It includes methods that are used by multiple plot classes, such as obtaining final</span>
<span class="sd">    validation data from kfold and train/test models, and putting new data through the</span>
<span class="sd">    models for both kfold and train/test protocols.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ParentPlotter.__init__"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ParentPlotter.get_kfold_data_from_model"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter.get_kfold_data_from_model">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_kfold_data_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the final validation data from a kfold model, meaning the data that was used to evaluate the model</span>
<span class="sd">        when the model training was complete.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the training set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        train_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the training set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        val_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the validation set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        val_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the validation set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        metrics_per_fold: dict</span>
<span class="sd">            Dictionary of the metrics for each fold.</span>
<span class="sd">            The keys are the names of the metrics and the values are lists of the metric values for each fold.</span>
<span class="sd">        overall_kfold_metrics: dict</span>
<span class="sd">            Dictionary of the overall kfold metrics. </span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the overall kfold,</span>
<span class="sd">            meaning the metric values for the concatenated final validation data over all the folds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">train_reals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_reals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_logits</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">metric_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># dictionary to store the metrics for each fold</span>
        <span class="n">metrics_per_fold</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">[],</span> <span class="n">metric_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">[]}</span>

        <span class="c1"># loop through the folds</span>
        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>  <span class="c1"># 0 is the model, 1 is the ckpt path</span>
            <span class="c1"># get the data points</span>
            <span class="n">train_reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">train_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">train_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">train_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">val_reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">val_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">val_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">val_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">val_logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">val_logits</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

            <span class="c1"># get the metrics</span>
            <span class="n">metrics_per_fold</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">metric1</span><span class="p">)</span>
            <span class="n">metrics_per_fold</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold</span><span class="o">.</span><span class="n">metric2</span><span class="p">)</span>

        <span class="c1"># concatenate the validation data points for the overall kfold performance</span>
        <span class="n">all_val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># get the overall kfold metrics</span>
        <span class="n">overall_kfold_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span>
            <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span>
        <span class="p">]:</span>  <span class="c1"># loop through the metrics</span>
            <span class="k">if</span> <span class="s2">&quot;auroc&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">all_val_logits</span>  <span class="c1"># AUROC needs logits</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">all_val_preds</span>

            <span class="n">val_step_acc</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">](</span>
                <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">predicted</span><span class="p">),</span>
                <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">all_val_reals</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">overall_kfold_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val_step_acc</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">train_reals</span><span class="p">,</span>
            <span class="n">train_preds</span><span class="p">,</span>
            <span class="n">val_reals</span><span class="p">,</span>
            <span class="n">val_preds</span><span class="p">,</span>
            <span class="n">metrics_per_fold</span><span class="p">,</span>
            <span class="n">overall_kfold_metrics</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ParentPlotter.get_tt_data_from_model"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter.get_tt_data_from_model">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_tt_data_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the final validation data from a train/test model, meaning the data that was used to evaluate the model</span>
<span class="sd">        when the model training was complete.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            A list of length 1 containing the trained pytorch_lightning model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the training set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        train_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the training set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        val_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the validation set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        val_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the validation set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        metric_values: dict</span>
<span class="sd">            Dictionary of the metrics for the model.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the model.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the model from the list of length 1</span>

        <span class="c1"># not training the model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># data points</span>
        <span class="n">train_reals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">val_reals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">val_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">val_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">val_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="c1"># metrics</span>
        <span class="n">metric_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">model</span><span class="o">.</span><span class="n">metric1</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">model</span><span class="o">.</span><span class="n">metric2</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">train_reals</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span></div>

<div class="viewcode-block" id="ParentPlotter.get_new_kfold_data"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter.get_new_kfold_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_new_kfold_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get new data by running through trained model for a kfold model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">        params: dict</span>
<span class="sd">            Additional parameters. Used for knowing where the checkpoint files are stored and </span>
<span class="sd">            creating the pytorch lightning data_module for the new data.</span>
<span class="sd">        data_file_suffix: str</span>
<span class="sd">            Suffix that is on the new data csv and pt files. e.g. &quot;_new_data&quot; or &quot;_test&quot;</span>
<span class="sd">        checkpoint_file_suffix: str, optional</span>
<span class="sd">            Suffix that is on the trained model checkpoint files. e.g. &quot;_firsttry&quot;. Added by the user.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the training set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        train_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the training set for each fold.</span>
<span class="sd">            This is stored in each trained model&#39;s class instance.</span>
<span class="sd">        val_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the new data set for each fold.</span>
<span class="sd">        val_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the new data set for each fold.</span>
<span class="sd">            This was obtained by running the new data through the trained model.</span>
<span class="sd">        metrics_per_fold: dict</span>
<span class="sd">            Dictionary of the metrics for each fold.</span>
<span class="sd">            The keys are the names of the metrics and the values are lists of the metric values for each fold.  </span>
<span class="sd">        overall_kfold_metrics: dict</span>
<span class="sd">            Dictionary of the overall kfold metrics.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the overall kfold,</span>
<span class="sd">            meaning the metric values for the concatenated new data over all the folds.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has a graph maker, it&#39;s not supported yet for creating graphs from new data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">train_reals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_reals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_logits</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">metric_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># dictionary to store the metrics for each fold</span>
        <span class="n">metrics_per_fold</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">[],</span> <span class="n">metric_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">[]}</span>

        <span class="n">params_copy</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># loop through the folds and get the predictions for each fold</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fold_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_list</span><span class="p">):</span>
            <span class="c1"># eval the model</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">fold_model</span>
            <span class="c1"># ckpt_path = fold_model[1]</span>

            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;graph_maker&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Model has a graph maker. This is not supported yet for creating graphs from new data.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subspace_ckpts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">subspace_model</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subspace_method</span><span class="o">.</span><span class="n">subspace_models</span><span class="p">:</span>
                    <span class="n">subspace_ckpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;checkpoint_dir&quot;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                        <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="n">subspace_model</span><span class="o">.</span><span class="vm">__name__</span>
                        <span class="o">+</span> <span class="s2">&quot;_fold_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">checkpoint_file_suffix</span>
                        <span class="o">+</span> <span class="s2">&quot;.ckpt&quot;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">subspace_ckpts</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">dm</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_data_module</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">params_copy</span><span class="p">,</span>
                <span class="n">optional_suffix</span><span class="o">=</span><span class="n">data_file_suffix</span><span class="p">,</span>
                <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">subspace_ckpts</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># just taking the first fold because we don&#39;t need to split the new data into folds</span>
            <span class="c1"># we just wanted to convert it to latent using that fold&#39;s trained subspace model</span>
            <span class="n">dm</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dm</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">([</span><span class="n">dm</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">])</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>

            <span class="n">trained_fusion_model_checkpoint</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_checkpoint_filename_for_trained_fusion_model</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">k</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">new_model</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
                <span class="n">trained_fusion_model_checkpoint</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                    <span class="n">pred_type</span><span class="o">=</span><span class="n">params</span><span class="p">[</span>
                        <span class="s2">&quot;pred_type&quot;</span>
                    <span class="p">],</span>  <span class="c1"># pred_type is a string (binary, regression, multiclass)</span>
                    <span class="n">data_dims</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">data_dims</span><span class="p">,</span>  <span class="c1"># data_dims is a list of tuples</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>  <span class="c1"># params is a dict))</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">new_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="n">fold_val_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fold_val_logits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fold_val_reals</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">get_data_from_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">get_model_outputs_and_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">loss</span><span class="p">,</span> <span class="n">end_output</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">out</span>

                <span class="n">fold_val_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">fold_val_logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">fold_val_reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

            <span class="n">fold_val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fold_val_reals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fold_val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fold_val_preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fold_val_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fold_val_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">val_reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_val_reals</span><span class="p">)</span>
            <span class="n">val_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_val_preds</span><span class="p">)</span>
            <span class="n">val_logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_val_logits</span><span class="p">)</span>
            <span class="n">train_reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">train_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">train_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">train_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span><span class="p">]:</span>  <span class="c1"># loop</span>
                <span class="k">if</span> <span class="s2">&quot;auroc&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="n">fold_val_logits</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="n">fold_val_preds</span>

                <span class="n">val_step_acc</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">](</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">predicted</span><span class="p">),</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">fold_val_reals</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="n">metrics_per_fold</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_step_acc</span><span class="p">)</span>

        <span class="c1"># concatenate the validation data points for the overall kfold performance</span>
        <span class="n">all_val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># get the overall kfold metrics</span>
        <span class="n">overall_kfold_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span>
            <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span>
        <span class="p">]:</span>  <span class="c1"># loop through the metrics</span>
            <span class="k">if</span> <span class="s2">&quot;auroc&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">all_val_logits</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">all_val_preds</span>

            <span class="n">val_step_acc</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">](</span>
                <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">predicted</span><span class="p">),</span>
                <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">all_val_reals</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">overall_kfold_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val_step_acc</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">train_reals</span><span class="p">,</span>
            <span class="n">train_preds</span><span class="p">,</span>
            <span class="n">val_reals</span><span class="p">,</span>
            <span class="n">val_preds</span><span class="p">,</span>
            <span class="n">metrics_per_fold</span><span class="p">,</span>
            <span class="n">overall_kfold_metrics</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ParentPlotter.get_new_tt_data"><a class="viewcode-back" href="../source/eval.html#eval.ParentPlotter.get_new_tt_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_new_tt_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get new data by running through trained model for a train/test model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            A list of length 1 containing the trained pytorch_lightning model.</span>
<span class="sd">        params: dict</span>
<span class="sd">            Additional parameters. Used for knowing where the checkpoint files are stored and </span>
<span class="sd">            creating the pytorch lightning data_module for the new data.</span>
<span class="sd">        data_file_suffix: str</span>
<span class="sd">            Suffix that is on the new data csv and pt files. e.g. &quot;_new_data&quot; or &quot;_test&quot;</span>
<span class="sd">        checkpoint_file_suffix: str, optional</span>
<span class="sd">            Suffix that is on the trained model checkpoint files. e.g. &quot;_firsttry&quot;. Added by the user.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the training set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        train_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the training set.</span>
<span class="sd">            This is stored in the trained model&#39;s class instance.</span>
<span class="sd">        val_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the new data set.</span>
<span class="sd">        val_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the new data set.</span>
<span class="sd">        metric_values: dict</span>
<span class="sd">            Dictionary of the metrics for the model.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the model.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has a graph maker, it&#39;s not supported yet for creating graphs from new data.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># eval the model</span>
        <span class="c1"># ckpt_path = model[0][1]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;graph_maker&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Model has a graph maker. This is not supported yet for creating graphs from new data.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subspace_ckpts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">subspace_model</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subspace_method</span><span class="o">.</span><span class="n">subspace_models</span><span class="p">:</span>
                <span class="n">subspace_ckpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;checkpoint_dir&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                    <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="o">+</span> <span class="n">subspace_model</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="o">+</span> <span class="n">checkpoint_file_suffix</span>
                    <span class="o">+</span> <span class="s2">&quot;.ckpt&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">subspace_ckpts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get data module (potentially will need to be trained with a subspace method or graph-maker)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_data_module</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">optional_suffix</span><span class="o">=</span><span class="n">data_file_suffix</span><span class="p">,</span>
            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">subspace_ckpts</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># concatenating the train and test datasets because we want to get the predictions for all the data</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">([</span><span class="n">dm</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">])</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>

        <span class="c1"># get ckpt_path from fusion name</span>
        <span class="n">trained_fusion_model_checkpoint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_checkpoint_filename_for_trained_fusion_model</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">new_model</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
            <span class="n">trained_fusion_model_checkpoint</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                <span class="n">pred_type</span><span class="o">=</span><span class="n">params</span><span class="p">[</span>
                    <span class="s2">&quot;pred_type&quot;</span>
                <span class="p">],</span>  <span class="c1"># pred_type is a string (binary, regression, multiclass)</span>
                <span class="n">data_dims</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">data_dims</span><span class="p">,</span>  <span class="c1"># data_dims is a list of tuples</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>  <span class="c1"># params is a dict))</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">new_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># get the predictions</span>
        <span class="n">end_outputs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logits_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reals_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">get_data_from_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">get_model_outputs_and_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">end_output</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">out</span>

            <span class="n">end_outputs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">logits_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">reals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

        <span class="c1"># get the train reals, train preds, val reals, val preds</span>
        <span class="n">train_reals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_reals</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">end_outputs_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reals_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">val_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">logits_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># metrics</span>
        <span class="n">metric_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">new_model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span>
            <span class="n">new_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pred_type</span>
        <span class="p">]:</span>  <span class="c1"># loop through the metrics</span>
            <span class="k">if</span> <span class="s2">&quot;auroc&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">val_logits</span>  <span class="c1"># AUROC needs logits</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">val_preds</span>

            <span class="n">metric_val</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">](</span>
                <span class="n">new_model</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">predicted</span><span class="p">),</span>
                <span class="n">new_model</span><span class="o">.</span><span class="n">safe_squeeze</span><span class="p">(</span><span class="n">val_reals</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">metric_values</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metric_val</span>

        <span class="k">return</span> <span class="n">train_reals</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span></div></div>


<div class="viewcode-block" id="RealsVsPreds"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds">[docs]</a><span class="k">class</span> <span class="nc">RealsVsPreds</span><span class="p">(</span><span class="n">ParentPlotter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the real values vs the predicted values for a model.</span>
<span class="sd">    Pink dots are the training data, green dots are the validation data. The validation data is</span>
<span class="sd">    either new data if using from_new_data or the original validation data if using from_final_val_data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RealsVsPreds.__init__"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

<div class="viewcode-block" id="RealsVsPreds.from_new_data"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds.from_new_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_new_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="o">=</span><span class="s2">&quot;_test&quot;</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Reals vs preds plot using new data (i.e. data that was not used to train or validate the model).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">            For train/test models, this is a list of length 1.</span>
<span class="sd">        params: dict</span>
<span class="sd">            Additional parameters. Used for knowing where the checkpoint files are stored and</span>
<span class="sd">            creating the pytorch lightning data_module for the new data.</span>
<span class="sd">        data_file_suffix: str</span>
<span class="sd">            Suffix for the data file e.g. _test means that the source files are</span>
<span class="sd">            ``params[&quot;tabular1_source_test]``, ``params[&quot;tabular2_source_test]``,</span>
<span class="sd">            ``params[&quot;img_source_test]``.</span>
<span class="sd">            Change this to whatever suffix you have chosen for your new data files.</span>
<span class="sd">            Default is &quot;_test&quot;.</span>
<span class="sd">        checkpoint_file_suffix: str, optional</span>
<span class="sd">            Suffix that is on the trained model checkpoint files. e.g. &quot;_firsttry&quot;. Added by the user.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not a list.</span>
<span class="sd">            If the model is a list of length &gt; 1 but kfold_flag is False.</span>
<span class="sd">            If the model is a list of length 1 but kfold_flag is True.</span>
<span class="sd">            If the model is an empty list.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Argument &#39;model_list&#39; is not a list. &quot;</span>
                    <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="s2">&quot;If you are using a train/test model, the single model must be in a list of length 1.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if isinstance(model, list):  # kfold model</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list but kfold_flag is False. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_kfold_data</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span>
            <span class="p">)</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reals_vs_preds_kfold</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;From new data&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># isinstance(model, nn.Module):  # train/test model</span>
            <span class="k">if</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list of one model but kfold_flag is True. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input (k must be larger than 1).&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metric_values</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_tt_data</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">,</span> <span class="n">checkpoint_file_suffix</span>
            <span class="p">)</span>

            <span class="c1"># plot the figure</span>
            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reals_vs_preds_tt</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span> <span class="n">train_reals</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span>
            <span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;From new data&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Argument &#39;model_list&#39; is an empty list. &quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span></div>

<div class="viewcode-block" id="RealsVsPreds.from_final_val_data"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds.from_final_val_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_final_val_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reals vs preds plot using the final validation data (i.e. the data that was used to evaluate the model</span>
<span class="sd">        when the model training was complete).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">            For train/test models, this is a list of length 1.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not a list.</span>
<span class="sd">            If the model is a list of length &gt; 1 but kfold_flag is False.</span>
<span class="sd">            If the model is a list of length 1 but kfold_flag is True.</span>
<span class="sd">            If the model is an empty list.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Argument &#39;model_list&#39; is not a list. &quot;</span>
                    <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="s2">&quot;If you are using a train/test model, the single model must be in a list of length 1.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># kfold model (list of models and their checkpoints)</span>
            <span class="c1"># if isinstance(model[0], list):  # kfold model</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list of length &gt; 1 but kfold_flag is False. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>


            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kfold_data_from_model</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reals_vs_preds_kfold</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;From final val data&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># isinstance(model[0], nn.Module):  # train/test model</span>

            <span class="k">if</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list of one model+checkpoint but kfold_flag is True. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="c1"># get the data</span>
            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metric_values</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tt_data_from_model</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span>

            <span class="c1"># plot the figure</span>
            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reals_vs_preds_tt</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span> <span class="n">train_reals</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span>
            <span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;From final val data&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Argument &#39;model_list&#39; is an empty list. &quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span></div>

<div class="viewcode-block" id="RealsVsPreds.reals_vs_preds_kfold"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds.reals_vs_preds_kfold">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reals_vs_preds_kfold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_list</span><span class="p">,</span>
        <span class="n">val_reals</span><span class="p">,</span>
        <span class="n">val_preds</span><span class="p">,</span>
        <span class="n">metrics_per_fold</span><span class="p">,</span>
        <span class="n">overall_kfold_metrics</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reals vs preds plot for a kfold model. This function should be called within the RealVsPreds class</span>
<span class="sd">        after the k-fold data has been obtained from the model (either old data or new data).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">        val_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the new data set for each fold.</span>
<span class="sd">        val_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the new data set for each fold.</span>
<span class="sd">        metrics_per_fold: dict</span>
<span class="sd">            Dictionary of the metrics for each fold.</span>
<span class="sd">            The keys are the names of the metrics and the values are lists of the metric values for each fold.</span>
<span class="sd">        overall_kfold_metrics: dict</span>
<span class="sd">            Dictionary of the overall kfold metrics.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the overall kfold,</span>
<span class="sd">            meaning the metric values for the concatenated new data over all the folds.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">first_fold_model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_per_fold</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">cols</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">subplots</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subfigures</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">ax0</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
            <span class="n">rows</span><span class="p">,</span>
            <span class="n">cols</span><span class="p">,</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">wspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="n">ax_og</span> <span class="o">=</span> <span class="n">ax1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_og</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_og</span><span class="p">)</span>

            <span class="c1"># get real and predicted values for the current fold</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="n">val_reals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">val_preds</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="c1"># plot real vs. predicted values</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">reals</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#f082ef&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>

            <span class="c1"># plot x=y line as a dashed line</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># set title of plot to the metric for the current fold</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fold </span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">metrics_per_fold</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">n</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># set x and y labels</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Real Values&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>

        <span class="n">all_val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># plot all real vs. predicted values</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_val_reals</span><span class="p">,</span> <span class="n">all_val_preds</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#f082ef&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>

        <span class="c1"># plot x=y line as a dashed line</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">overall_kfold_metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># set x and y labels</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Real Values&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>

        <span class="c1"># Set the overall title for the entire figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: reals vs. predicteds&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="RealsVsPreds.reals_vs_preds_tt"><a class="viewcode-back" href="../source/eval.html#eval.RealsVsPreds.reals_vs_preds_tt">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reals_vs_preds_tt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">train_reals</span><span class="p">,</span> <span class="n">train_preds</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reals vs preds plot for a train/test model. This function should be called within the RealVsPreds class</span>
<span class="sd">        after the train/test data has been obtained from the model (either old data or new data).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model: list</span>
<span class="sd">            A list of length 1 containing the trained pytorch_lightning model.</span>
<span class="sd">        train_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the training set.</span>
<span class="sd">        train_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the training set.</span>
<span class="sd">        val_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the new data set.</span>
<span class="sd">        val_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the new data set.</span>
<span class="sd">        metric_values: dict</span>
<span class="sd">            Dictionary of the metrics for the model.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">train_reals</span><span class="p">,</span>
            <span class="n">train_preds</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#f082ef&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#00b64e&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">)</span>

        <span class="c1"># Get the limits of the current scatter plot</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>

        <span class="c1"># Set up data points for the x=y line</span>
        <span class="n">line_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">line_y</span> <span class="o">=</span> <span class="n">line_x</span>

        <span class="c1"># Plot the x=y line as a dashed line</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line_x</span><span class="p">,</span> <span class="n">line_y</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x=y Line&quot;</span><span class="p">)</span>

        <span class="n">metric1_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="si">}</span><span class="s2"> - Validation </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_values</span><span class="p">[</span><span class="n">metric1_name</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Real Values&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ConfusionMatrix"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix">[docs]</a><span class="k">class</span> <span class="nc">ConfusionMatrix</span><span class="p">(</span><span class="n">ParentPlotter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the confusion matrix for a model. This should be used for classification models only (binary or multiclass).</span>
<span class="sd">    The data used to create the confusion matrix is either new data if using from_new_data or the original validation data</span>
<span class="sd">    if using from_final_val_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ConfusionMatrix.__init__"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConfusionMatrix.from_new_data"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix.from_new_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_new_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="o">=</span><span class="s2">&quot;_test&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confusion matrix using new data (i.e. data that was not used to train or validate the model).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">            For train/test models, this is a list of length 1.</span>
<span class="sd">        params: dict</span>
<span class="sd">            Additional parameters. Used for knowing where the checkpoint files are stored and</span>
<span class="sd">            creating the pytorch lightning data_module for the new data.</span>
<span class="sd">        data_file_suffix: str</span>
<span class="sd">            Suffix for the data file e.g. _test means that the source files are</span>
<span class="sd">            ``params[&quot;tabular1_source_test]``, ``params[&quot;tabular2_source_test]``,</span>
<span class="sd">            ``params[&quot;img_source_test]``.</span>
<span class="sd">            Change this to whatever suffix you have chosen for your new data files.</span>
<span class="sd">            Default is &quot;_test&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not a list.</span>
<span class="sd">            If the model is a list of length &gt; 1 but kfold_flag is False.</span>
<span class="sd">            If the model is a list of length 1 but kfold_flag is True.</span>
<span class="sd">            If the model is an empty list.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Argument &#39;model_list&#39; is not a list. &quot;</span>
                    <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="s2">&quot;If you are using a train/test model, the single model must be in a list of length 1.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># kfold model</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list but kfold_flag is False. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_kfold_data</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">)</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confusion_matrix_kfold</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># train/test model</span>
            <span class="k">if</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list of one model but kfold_flag is True. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input (k must be larger than 1).&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metric_values</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_tt_data</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">data_file_suffix</span><span class="p">)</span>

            <span class="c1"># plot the figure</span>
            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confusion_matrix_tt</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Argument &#39;model_list&#39; is an empty list. &quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span></div>

<div class="viewcode-block" id="ConfusionMatrix.from_final_val_data"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix.from_final_val_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_final_val_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confusion matrix using the final validation data (i.e. the data that was used to evaluate the model</span>
<span class="sd">        when the model training was complete).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">            For train/test models, this is a list of length 1.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        figure: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not a list.</span>
<span class="sd">            If the model is a list of length &gt; 1 but kfold_flag is False.</span>
<span class="sd">            If the model is a list of length 1 but kfold_flag is True.</span>
<span class="sd">            If the model is an empty list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Argument &#39;model_list&#39; is not a list. &quot;</span>
                    <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="s2">&quot;If you are using a train/test model, the single model must be in a list of length 1.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># kfold model</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list but kfold_flag is False. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kfold_data_from_model</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confusion_matrix_kfold</span><span class="p">(</span>
                <span class="n">model_list</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metrics_per_fold</span><span class="p">,</span>
                <span class="n">overall_kfold_metrics</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># train/test model</span>
            <span class="k">if</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Argument &#39;model_list&#39; is a list of one model but kfold_flag is True. &quot;</span>
                        <span class="s2">&quot;Please check the model and the function input (k must be larger than 1).&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="p">(</span>
                <span class="n">train_reals</span><span class="p">,</span>
                <span class="n">train_preds</span><span class="p">,</span>
                <span class="n">val_reals</span><span class="p">,</span>
                <span class="n">val_preds</span><span class="p">,</span>
                <span class="n">metric_values</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tt_data_from_model</span><span class="p">(</span><span class="n">model_list</span><span class="p">)</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confusion_matrix_tt</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Argument &#39;model_list&#39; is an empty list. &quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span></div>

<div class="viewcode-block" id="ConfusionMatrix.confusion_matrix_tt"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix.confusion_matrix_tt">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">confusion_matrix_tt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">val_reals</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">metric_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confusion matrix for a train/test model. This function should be called within the ConfusionMatrix class</span>
<span class="sd">        after the train/test data has been obtained from the model (either old data or new data).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            A list of length 1 containing the trained pytorch_lightning model.</span>
<span class="sd">        val_reals: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the real values for the new data set.</span>
<span class="sd">        val_preds: torch.Tensor</span>
<span class="sd">            Torch.Tensor of the predicted values for the new data set.</span>
<span class="sd">        metric_values: dict</span>
<span class="sd">            Dictionary of the metrics for the model.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">val_preds</span><span class="p">)</span>

        <span class="c1"># Create a figure and axis for the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">))</span>

        <span class="c1"># Plot the confusion matrix as a heatmap</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdPu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># Add the value of each cell to the plot</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">conf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="s2">&quot;xx-large&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Actuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">metric1_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="si">}</span><span class="s2"> - Validation </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_values</span><span class="p">[</span><span class="n">metric1_name</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ConfusionMatrix.confusion_matrix_kfold"><a class="viewcode-back" href="../source/eval.html#eval.ConfusionMatrix.confusion_matrix_kfold">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">confusion_matrix_kfold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_list</span><span class="p">,</span>
        <span class="n">val_reals</span><span class="p">,</span>
        <span class="n">val_preds</span><span class="p">,</span>
        <span class="n">metrics_per_fold</span><span class="p">,</span>
        <span class="n">overall_kfold_metrics</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confusion matrix for a kfold model. This function should be called within the ConfusionMatrix class</span>
<span class="sd">        after the k-fold data has been obtained from the model (either old data or new data).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list</span>
<span class="sd">            List of trained pytorch_lightning models. For kfold models, this is a list of at least length 2, where the first</span>
<span class="sd">            element is the k=1 model and the second element is the k=2 model, etc.</span>
<span class="sd">        val_reals: list</span>
<span class="sd">            List of torch.Tensors of the real values for the new data set for each fold.</span>
<span class="sd">        val_preds: list</span>
<span class="sd">            List of torch.Tensors of the predicted values for the new data set for each fold.</span>
<span class="sd">        metrics_per_fold: dict</span>
<span class="sd">            Dictionary of the metrics for each fold.</span>
<span class="sd">            The keys are the names of the metrics and the values are lists of the metric values for each fold.</span>
<span class="sd">        overall_kfold_metrics: dict</span>
<span class="sd">            Dictionary of the overall kfold metrics.</span>
<span class="sd">            The keys are the names of the metrics and the values are the metric values for the overall kfold,</span>
<span class="sd">            meaning the metric values for the concatenated new data over all the folds.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_fold_model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_per_fold</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">cols</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">subplots</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subfigures</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">ax0</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
            <span class="n">rows</span><span class="p">,</span>
            <span class="n">cols</span><span class="p">,</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="n">ax_og</span> <span class="o">=</span> <span class="n">ax1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_og</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_og</span><span class="p">)</span>

            <span class="c1"># get real and predicted values for the current fold</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="n">val_reals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">val_preds</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">reals</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">preds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdPu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># Add the value of each cell to the plot</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                        <span class="n">s</span><span class="o">=</span><span class="n">conf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">size</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Actuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fold </span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">metrics_per_fold</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">n</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># gs.tight_layout(fig)</span>
        <span class="n">all_val_reals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_reals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_val_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># plot all real vs. predicted values</span>
        <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">all_val_reals</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">all_val_preds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Plot the confusion matrix as a heatmap</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdPu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># Add the value of each cell to the plot</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">conf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="s2">&quot;xx-large&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Actuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">overall_kfold_metrics</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Set the overall title for the entire figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_fold_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: confusion matrix&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ModelComparison"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison">[docs]</a><span class="k">class</span> <span class="nc">ModelComparison</span><span class="p">(</span><span class="n">ParentPlotter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the performance of multiple models on a single plot. Currently (as of 2023-10-11) this is only</span>
<span class="sd">    implemented for from_final_val_data because it is not clear how to implement from_new_data for graph-based models, so </span>
<span class="sd">    they would have to be left out of the main plot (which feels wrong tbh).</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ModelComparison.__init__"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelComparison.from_final_val_data"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.from_final_val_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_final_val_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kfold_flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plotting function for comparing models on metrics using the final validation data (i.e. the data that was used to evaluate the model</span>
<span class="sd">        when the model training was complete).</span>
<span class="sd">        Produces a violin plot if kfold_flag is True and a bar plot if kfold_flag is False.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_list: list of lists</span>
<span class="sd">            List of trained pytorch_lightning models.</span>
<span class="sd">            For k-fold, this is a list with length number of fusion methods, where each element is a list of length k</span>
<span class="sd">            containing the trained pytorch_lightning models for each fold.</span>
<span class="sd">            For train/test, this is a list of length number of fusion methods, where each element is a list of length 1</span>
<span class="sd">            containing the trained pytorch_lightning model.</span>
<span class="sd">        kfold_flag: bool</span>
<span class="sd">            True if the model is a kfold model, False if the model is a train/test model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib.pyplot.figure</span>
<span class="sd">            The figure of the plot.</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            The dataframe of the metrics.</span>
<span class="sd">    </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comparing_models_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">kfold_flag</span><span class="p">:</span>
            <span class="n">overall_kfold_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1">#</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>

                <span class="p">(</span>
                    <span class="n">train_reals</span><span class="p">,</span>
                    <span class="n">train_preds</span><span class="p">,</span>
                    <span class="n">val_reals</span><span class="p">,</span>
                    <span class="n">val_preds</span><span class="p">,</span>
                    <span class="n">metrics_per_fold</span><span class="p">,</span>
                    <span class="n">overall_kfold_metrics</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kfold_data_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

                <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_per_fold</span>

                <span class="n">overall_kfold_metrics_dict</span><span class="p">[</span>
                    <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">overall_kfold_metrics</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfold_comparison_plot</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performance_dataframe</span><span class="p">(</span>
                <span class="n">comparing_models_metrics</span><span class="p">,</span> <span class="n">overall_kfold_metrics_dict</span><span class="p">,</span> <span class="n">kfold_flag</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
                <span class="p">(</span>
                    <span class="n">train_reals</span><span class="p">,</span>
                    <span class="n">train_preds</span><span class="p">,</span>
                    <span class="n">val_reals</span><span class="p">,</span>
                    <span class="n">val_preds</span><span class="p">,</span>
                    <span class="n">metric_values</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tt_data_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

                <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_values</span>

            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_test_comparison_plot</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performance_dataframe</span><span class="p">(</span>
                <span class="n">comparing_models_metrics</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kfold_flag</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span><span class="p">,</span> <span class="n">df</span></div>

<div class="viewcode-block" id="ModelComparison.from_new_data"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.from_new_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_new_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ModelComparison.kfold_comparison_plot"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.kfold_comparison_plot">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">kfold_comparison_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comparing_models_metrics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plotting function for comparing models on kfold metrics. Produces a violin plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comparing_models_metrics: dict</span>
<span class="sd">            Dictionary of metrics. Keys are the model names and values are dict {metric1name: metric_value, metric2name: metric_value}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib figure</span>
<span class="sd">            Figure containing the violin plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get method names and metric names</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;comp models metrics&quot;</span><span class="p">,</span> <span class="n">comparing_models_metrics</span><span class="p">)</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">comparing_models_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># [method1name, method2name,...]</span>

        <span class="n">metric1name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metric2name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get metric values for each method</span>
        <span class="n">metric_1_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">metric1name</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_names</span>
        <span class="p">]</span>
        <span class="n">metric_2_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">metric2name</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_names</span>
        <span class="p">]</span>

        <span class="c1"># Calculate mean or median of metric_1_values for sorting</span>
        <span class="n">metric_1_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric_1_values</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># Change to median if needed</span>

        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">metric_1_means</span><span class="p">)</span>

        <span class="c1"># Reorder method names, metric values, and other related data</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">method_names</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>
        <span class="n">metric_1_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric_1_values</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">metric_2_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric_2_values</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># create figure 1x2 subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="c1"># create violin plots for each metric</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">metric_1_values</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_violin_colors</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">colour</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]:</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">colour</span><span class="p">)</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;cmeans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;cmins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;cmaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;cbars&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="n">set_violin_colors</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s2">&quot;violet&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">bp2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">metric_2_values</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_violin_colors</span><span class="p">(</span><span class="n">bp2</span><span class="p">,</span> <span class="s2">&quot;powderblue&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_2_values</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>

        <span class="c1"># set titles and limits</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric1name</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric2name</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Distribution of metrics between cross-validation folds&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ModelComparison.train_test_comparison_plot"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.train_test_comparison_plot">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">train_test_comparison_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comparing_models_metrics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plotting function for comparing models on train and test metrics. Produces a horizontal bar chart.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comparing_models_metrics: dict</span>
<span class="sd">            Dictionary of metrics. Keys are the model names and values are dict {metric1name: metric_value, metric2name: metric_value}</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: matplotlib figure</span>
<span class="sd">            Figure containing the horizontal bar chart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">comparing_models_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># [method1name, method2name,...]</span>

        <span class="n">metric1name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metric2name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get metric values for each method</span>
        <span class="n">metric_1_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">metric1name</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_names</span>
        <span class="p">]</span>
        <span class="n">metric_2_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">metric2name</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_names</span>
        <span class="p">]</span>

        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">metric_1_values</span><span class="p">)</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">method_names</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>
        <span class="n">metric_1_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric_1_values</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>
        <span class="n">metric_2_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric_2_values</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>

        <span class="c1"># Create an array of indices for the x-axis</span>
        <span class="n">y_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">))</span>

        <span class="c1"># Width of the bars</span>
        <span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.35</span>

        <span class="c1"># Create the figure and the primary y-axis</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="c1"># Create the first bar chart using the primary y-axis (ax1)</span>
        <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">y_indices</span><span class="p">,</span>
            <span class="n">metric_1_values</span><span class="p">,</span>
            <span class="n">bar_width</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;violet&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span>
        <span class="p">)</span>

        <span class="c1"># black dashed line at x=0</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">)))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Create a secondary y-axis for the second metric</span>
        <span class="c1"># ax2 = ax1.twiny()</span>

        <span class="c1"># Create the second bar chart using the secondary y-axis (ax2)</span>
        <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">y_indices</span><span class="p">,</span>
            <span class="n">metric_2_values</span><span class="p">,</span>
            <span class="n">bar_width</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;powderblue&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">)))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_2_values</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>

        <span class="c1"># set titles and limits</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric1name</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric2name</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Show the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Model Performance Comparison&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ModelComparison.get_performance_dataframe"><a class="viewcode-back" href="../source/eval.html#eval.ModelComparison.get_performance_dataframe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_performance_dataframe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">comparing_models_metrics</span><span class="p">,</span> <span class="n">overall_kfold_metrics_dict</span><span class="p">,</span> <span class="n">kfold_flag</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dataframe of the performance metrics for each model.</span>
<span class="sd">        For kfold models, the dataframe contains the overall kfold metrics and the metrics for each fold.</span>
<span class="sd">        For train/test models, the dataframe contains the metrics for the train and test sets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comparing_models_metrics: dict</span>
<span class="sd">            Dictionary of metrics. Keys are the model names and values are dict {metric1name: metric_value, metric2name: metric_value}</span>
<span class="sd">        overall_kfold_metrics_dict: dict</span>
<span class="sd">            Dictionary of overall kfold metrics. Keys are the model names and values are dict {metric1name: metric_value, metric2name: metric_value}</span>
<span class="sd">        kfold_flag: bool</span>
<span class="sd">            True if the model is a kfold model, False if the model is a train/test model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            Dataframe of the performance metrics for each model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">comparing_models_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># [method1name, method2name,...]</span>
        <span class="n">metric1name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metric2name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">[</span><span class="n">method_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kfold_flag</span><span class="p">:</span>

            <span class="n">overall_kfold_metrics_copy</span> <span class="o">=</span> <span class="n">overall_kfold_metrics_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">overall_kfold_metrics_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">overall_kfold_metrics_copy</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">overall_kfold_metrics_copy</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="c1"># Create a DataFrame for overall kfold metrics</span>
            <span class="n">folds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparing_models_metrics</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">folds_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Method&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">num_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">folds_df</span><span class="p">[</span><span class="n">metric1name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fold_columns_metric1</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;fold</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric1name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">fold_columns_metric2</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;fold</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric2name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fold_columns_metric1</span><span class="p">):</span>
                <span class="n">folds_df</span><span class="p">[</span><span class="n">fold_columns_metric1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">folds_df</span><span class="p">[</span><span class="n">metric1name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">folds_df</span><span class="p">[</span><span class="n">fold_columns_metric2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">folds_df</span><span class="p">[</span><span class="n">metric2name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

            <span class="n">folds_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">metric1name</span><span class="p">,</span> <span class="n">metric2name</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">folds_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Method&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">folds_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">final_df</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Reshape the data into a list of dictionaries</span>
            <span class="n">reshaped_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">comparing_models_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">reshaped_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">metrics</span><span class="p">})</span>

            <span class="c1"># Create a DataFrame from the reshaped data</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">reshaped_data</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Method&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">df</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Florence J Townend.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>