<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fusilli.data &mdash; fusilli  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/florencestheme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/pink_pasta_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fusilli
              <img src="../../_static/pink_pasta_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Table of Contents ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html"><strong>fusilli</strong>: an introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Quick-Run Fusilli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fusion_model_explanations.html">Fusion Model Explanations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modifying_models.html">Modifying the fusion models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact_me.html">Contact me</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ Tutorials ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/training_and_testing/index.html">Training and testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/customising_behaviour/index.html">Customising behaviour</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ How to contribute ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing_examples/index.html">Fusion Model Templates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸŒ¸ API Reference ðŸŒ¸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary/fusilli.fusionmodels.html">fusilli.fusionmodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary/fusilli.data.html">fusilli.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary/fusilli.train.html">fusilli.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary/fusilli.eval.html">fusilli.eval</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autosummary/fusilli.utils.html">fusilli.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fusilli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fusilli.data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fusilli.data</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Data loading classes for multimodal and unimodal data.</span>
<span class="sd">This file contains functions and classes for loading the data for the different modalities, and</span>
<span class="sd">in training the subspace methods on the data (if the subspace methods need pre-training).</span>
<span class="sd">Train/test splits and k-fold cross validation are also implemented here.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">lightning.pytorch</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torch_geometric.data.lightning</span> <span class="kn">import</span> <span class="n">LightningNodeData</span>
<span class="kn">from</span> <span class="nn">fusilli.utils</span> <span class="kn">import</span> <span class="n">model_modifier</span>


<div class="viewcode-block" id="downsample_img_batch"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.downsample_img_batch">[docs]</a><span class="k">def</span> <span class="nf">downsample_img_batch</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downsamples a batch of images to a specified size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : array-like</span>
<span class="sd">        Batch of images. Shape (batch_size, channels, height, width) or (batch_size, channels,</span>
<span class="sd">        height, width, depth) for 3D images.</span>

<span class="sd">    output_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width) or (height, width, depth) for 3D images.</span>
<span class="sd">        Do not put the batch_size dimension in the tuple.</span>
<span class="sd">        If None, no downsampling is performed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    downsampled_img : array-like</span>
<span class="sd">        Downsampled image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">output_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if no downsampling</span>
        <span class="k">return</span> <span class="n">imgs</span>

    <span class="c1"># if number of output_size dims is equal to number of image dims - 3</span>
    <span class="c1"># (i.e. if output_size is (64) and image is (16, 3, 128, 128))</span>
    <span class="c1"># or output_size is (64, 64) and image is (16, 3, 128, 128, 128))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="o">==</span> <span class="n">imgs</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must have </span><span class="si">{</span><span class="n">imgs</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3</span><span class="si">}</span><span class="s2"> dimensions, not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\</span>
<span class="s2">                Make sure to exclude the channel dimension so output_size looks like</span><span class="se">\</span>
<span class="s2">                    (height, width) for 2D or (height, width, depth) for 3D.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if output_size has a negative value</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_size</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must not have negative values, but got </span><span class="si">{</span><span class="n">output_size</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if output_size has more than 3 dimensions</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must have 2 or 3 dimensions, not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if output_size has more than 2 dimensions and image is 2D</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">imgs</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must have 2 dimensions, not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="si">}</span><span class="s2"> because img_dims indicates a 2D image.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if output_size has more than 4 dimensions and image is 3D</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">imgs</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must have 3 dimensions, not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="si">}</span><span class="s2"> because img_dims indicates a 3D image.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if output_size is larger than image dimensions</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;output_size must be smaller than image dimensions, but got </span><span class="si">{</span><span class="n">output_size</span><span class="si">}</span><span class="s2"> and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;image dimensions </span><span class="si">{</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">downsampled_img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">downsampled_img</span></div>


<div class="viewcode-block" id="CustomDataset"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.CustomDataset">[docs]</a><span class="k">class</span> <span class="nc">CustomDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom dataset class for multimodal data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    multimodal_flag : bool</span>
<span class="sd">        Flag for multimodal data. True if multimodal, False if unimodal.</span>
<span class="sd">    dataset1 : tensor</span>
<span class="sd">        Tensor of predictive features for modality 1.</span>
<span class="sd">    dataset2 : tensor</span>
<span class="sd">        Tensor of predictive features for modality 2.</span>
<span class="sd">    dataset : tensor</span>
<span class="sd">        Tensor of predictive features for uni-modal data.</span>
<span class="sd">    labels : tensor</span>
<span class="sd">        Tensor of labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomDataset.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.CustomDataset.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_features</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        pred_features : list or tensor</span>
<span class="sd">            List of tensors or tensor of predictive features</span>
<span class="sd">            (i.e. tabular or image data without labels).</span>
<span class="sd">        labels : dataframe</span>
<span class="sd">            Dataframe of labels (column name must be &quot;pred_label&quot;).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If pred_features is not a list or tensor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if pred_features is a list: it&#39;s multimodal data</span>
        <span class="c1"># only 2 modalities are supported currently</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span> <span class="o">=</span> <span class="n">pred_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset2</span> <span class="o">=</span> <span class="n">pred_features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># if pred_features is a tensor: it&#39;s unimodal data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;pred_features must be a list or a tensor, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pred_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># convert labels to tensor and correct dtype</span>
        <span class="n">label_type</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;int64&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the length of the dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Length of the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the item at the specified index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            Index of the item to return.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset1</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset2</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="LoadDatasets"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets">[docs]</a><span class="k">class</span> <span class="nc">LoadDatasets</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for loading the different datasets for the different modalities.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tabular1_source : str</span>
<span class="sd">        Source csv file for tabular1 data.</span>
<span class="sd">    tabular2_source : str</span>
<span class="sd">        Source csv file for tabular2 data.</span>
<span class="sd">    img_source : str</span>
<span class="sd">        Source torch file for image data.</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">        images.</span>
<span class="sd">        None if not downsampling. (default None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LoadDatasets.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">img_downsample_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">            [tabular1_source, tabular2_source, img_source]</span>
<span class="sd">        img_downsample_dims : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images.</span>
<span class="sd">            None if not downsampling. (default None)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If sources is not a list.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the CSVs do not have the right columns or if the index column is not named</span>
<span class="sd">            &quot;study_id&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_source</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">img_downsample_dims</span>  <span class="c1"># can choose own image size here</span>
        <span class="p">)</span>

        <span class="c1"># read in the csv files and raise errors if they don&#39;t have the right columns</span>
        <span class="c1"># or if the index column is not named &quot;study_id&quot;</span>
        <span class="n">tab1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>
        <span class="n">tab2_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;study_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab1_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CSV must have an index column named &#39;study_id&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;pred_label&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab1_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CSV must have a label column named &#39;pred_label&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;study_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab2_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CSV must have an index column named &#39;study_id&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;pred_label&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab2_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CSV must have a label column named &#39;pred_label&#39;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoadDatasets.load_tabular1"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.load_tabular1">[docs]</a>    <span class="k">def</span> <span class="nf">load_tabular1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>

        <span class="n">tab_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>

        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_tabular2"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.load_tabular2">[docs]</a>    <span class="k">def</span> <span class="nf">load_tabular2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular2-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tab_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">)</span>

        <span class="n">tab_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">pred_features</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>
        <span class="n">mod2_dim</span> <span class="o">=</span> <span class="n">pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod2_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_img"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.load_img">[docs]</a>    <span class="k">def</span> <span class="nf">load_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the image-only dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_scans</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_source</span><span class="p">)</span>
        <span class="n">all_scans_ds</span> <span class="o">=</span> <span class="n">downsample_img_batch</span><span class="p">(</span><span class="n">all_scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span>

        <span class="c1"># get the labels from the tabular1 dataset</span>
        <span class="n">label_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>

        <span class="n">label_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">label_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">all_scans_ds</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">)</span>

        <span class="n">img_dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_scans_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># not including batch size or channels</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_dim</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_both_tabular"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.load_both_tabular">[docs]</a>    <span class="k">def</span> <span class="nf">load_both_tabular</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1 and tabular2 multimodal dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tab1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>
        <span class="n">tab2_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular2_source</span><span class="p">)</span>

        <span class="n">tab1_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tab2_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tab1_pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab1_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">tab2_pred_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab2_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">tab1_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">([</span><span class="n">tab1_pred_features</span><span class="p">,</span> <span class="n">tab2_pred_features</span><span class="p">],</span> <span class="n">pred_label</span><span class="p">)</span>

        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">tab1_pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod2_dim</span> <span class="o">=</span> <span class="n">tab2_pred_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="n">mod2_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="LoadDatasets.load_tab_and_img"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.LoadDatasets.load_tab_and_img">[docs]</a>    <span class="k">def</span> <span class="nf">load_tab_and_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the tabular1 and image multimodal dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset (tensor): tensor of predictive features</span>
<span class="sd">        data_dims (list): list of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tab1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabular1_source</span><span class="p">)</span>

        <span class="n">tab1_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;study_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tab1_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">tab1_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">label_df</span> <span class="o">=</span> <span class="n">tab1_df</span><span class="p">[[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]]</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_source</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">downsample_img_batch</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">([</span><span class="n">tab1_features</span><span class="p">,</span> <span class="n">imgs</span><span class="p">],</span> <span class="n">label_df</span><span class="p">)</span>
        <span class="n">mod1_dim</span> <span class="o">=</span> <span class="n">tab1_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">img_dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># not including batch size or channels</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">mod1_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_dim</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="TrainTestDataModule"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule">[docs]</a><span class="k">class</span> <span class="nc">TrainTestDataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files. [Tabular1, Tabular2, Image]</span>
<span class="sd">    modality_methods : dict</span>
<span class="sd">        Dictionary of methods for loading the different modalities.</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary of parameters.</span>
<span class="sd">    fusion_model : class</span>
<span class="sd">        fusion model class. e.g. TabularCrossmodalAttention.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8).</span>
<span class="sd">    test_size : float</span>
<span class="sd">        Fraction of data to use for testing (default 0.2).</span>
<span class="sd">    pred_type : str</span>
<span class="sd">        Prediction type (binary, multiclass, or regression).</span>
<span class="sd">    multiclass_dims : int</span>
<span class="sd">        Number of classes for multiclass prediction (default None).</span>
<span class="sd">    subspace_method : class</span>
<span class="sd">        Subspace method class (default None) (only for subspace methods).</span>
<span class="sd">    layer_mods : dict</span>
<span class="sd">        Dictionary of layer modifications to make to the subspace method.</span>
<span class="sd">        (default None)</span>
<span class="sd">    max_epochs : int</span>
<span class="sd">        Maximum number of epochs to train subspace methods for. (default 1000)</span>
<span class="sd">    dataset : tensor</span>
<span class="sd">        Tensor of predictive features. Created in prepare_data().</span>
<span class="sd">    data_dims : list</span>
<span class="sd">        List of data dimensions [mod1_dim, mod2_dim, img_dim].</span>
<span class="sd">        Created in prepare_data().</span>
<span class="sd">    train_dataset : tensor</span>
<span class="sd">        Tensor of predictive features for training. Created in setup().</span>
<span class="sd">    test_dataset : tensor</span>
<span class="sd">        Tensor of predictive features for testing. Created in setup().</span>
<span class="sd">    subspace_method_train : class</span>
<span class="sd">        Subspace method class trained (only for subspace methods).</span>
<span class="sd">    own_early_stopping_callback : pytorch_lightning.callbacks.EarlyStopping</span>
<span class="sd">        Early stopping callback class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TrainTestDataModule.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">fusion_model</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">subspace_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">layer_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">own_early_stopping_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        fusion_model : class</span>
<span class="sd">            Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size (default 8).</span>
<span class="sd">        subspace_method : class</span>
<span class="sd">            Subspace method class (default None) (only for subspace methods).</span>
<span class="sd">        image_downsample_size : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images.</span>
<span class="sd">            None if not downsampling. (default None)</span>
<span class="sd">        layer_mods : dict</span>
<span class="sd">            Dictionary of layer modifications to make to the subspace method.</span>
<span class="sd">            (default None)</span>
<span class="sd">        max_epochs : int</span>
<span class="sd">            Maximum number of epochs to train subspace methods for. (default 1000)</span>
<span class="sd">        extra_log_string_dict : dict</span>
<span class="sd">            Dictionary of extra strings to add to the log.</span>
<span class="sd">        own_early_stopping_callback : pytorch_lightning.callbacks.EarlyStopping</span>
<span class="sd">            Early stopping callback class (default None).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_log_string_dict</span> <span class="o">=</span> <span class="n">extra_log_string_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span> <span class="o">=</span> <span class="n">fusion_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;pred_type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">==</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiclass_dims</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;multiclass_dims&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiclass_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="o">=</span> <span class="n">subspace_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="o">=</span> <span class="n">layer_mods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">own_early_stopping_callback</span> <span class="o">=</span> <span class="n">own_early_stopping_callback</span></div>

<div class="viewcode-block" id="TrainTestDataModule.prepare_data"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="TrainTestDataModule.setup"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified.</span>
<span class="sd">        If checkpoint_path is specified, the subspace method is loaded from the checkpoint and not trained.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        checkpoint_path : str</span>
<span class="sd">            Path to the checkpoint file for the subspace method (default None).</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        train_dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        val_dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># split the dataset into train and test sets</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if subspace method is specified</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>  <span class="c1"># if no checkpoint path specified, train the subspace method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span>
                    <span class="n">datamodule</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">train_subspace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># modify the subspace method architecture if specified</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># train the subspace method and convert train dataset to the latent space</span>
                <span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span>
                <span class="p">)</span>

                <span class="c1"># convert the test dataset to the latent space</span>
                <span class="p">(</span>
                    <span class="n">test_latents</span><span class="p">,</span>
                    <span class="n">test_labels</span><span class="p">,</span>
                    <span class="n">data_dims</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">)</span>

                <span class="c1"># create the new train and test datasets from the latent space with updated dimensions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we have already trained the subspace method, so load it from the checkpoint</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                    <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">train_subspace</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>  <span class="c1"># will return a init subspace method with the subspace models as instance attributes</span>

                <span class="c1"># modify the subspace method architecture if specified</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># load checkpoint state dict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="o">.</span><span class="n">load_ckpt</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>

                <span class="c1"># converting the train and test datasets to the latent space</span>
                <span class="p">(</span>
                    <span class="n">train_latents</span><span class="p">,</span>
                    <span class="n">train_labels</span><span class="p">,</span>
                    <span class="n">data_dims</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">)</span>

                <span class="p">(</span>
                    <span class="n">test_latents</span><span class="p">,</span>
                    <span class="n">test_labels</span><span class="p">,</span>
                    <span class="n">data_dims</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_train</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">)</span>

                <span class="c1"># create the new train and test datasets from the latent space with updated dimensions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span></div>

<div class="viewcode-block" id="TrainTestDataModule.train_dataloader"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule.train_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for training.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TrainTestDataModule.val_dataloader"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestDataModule.val_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for validation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="KFoldDataModule"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule">[docs]</a><span class="k">class</span> <span class="nc">KFoldDataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with k-fold cross</span>
<span class="sd">    validation</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_folds : int</span>
<span class="sd">        Total number of folds.</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files. [Tabular1, Tabular2, Image]</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">        images.</span>
<span class="sd">        None if not downsampling. (default None)</span>
<span class="sd">    modality_methods : dict</span>
<span class="sd">        Dictionary of methods for loading the different modalities.</span>
<span class="sd">    fusion_model : class</span>
<span class="sd">        Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8).</span>
<span class="sd">    pred_type : str</span>
<span class="sd">        Prediction type (binary, multiclass, regression).</span>
<span class="sd">    multiclass_dims : int</span>
<span class="sd">        Number of classes for multiclass prediction (default None).</span>
<span class="sd">    subspace_method : class</span>
<span class="sd">        Subspace method class (default None) (only for subspace methods).</span>
<span class="sd">    layer_mods : dict</span>
<span class="sd">        Dictionary of layer modifications to make to the subspace method.</span>
<span class="sd">        (default None)</span>
<span class="sd">    max_epochs : int</span>
<span class="sd">        Maximum number of epochs to train subspace methods for. (default 1000)</span>
<span class="sd">    dataset : tensor</span>
<span class="sd">        Tensor of predictive features. Created in prepare_data().</span>
<span class="sd">    data_dims : list</span>
<span class="sd">        List of data dimensions [mod1_dim, mod2_dim, img_dim]. Created in prepare_data().</span>
<span class="sd">    train_dataset : tensor</span>
<span class="sd">        Tensor of predictive features for training. Created in setup().</span>
<span class="sd">    test_dataset : tensor</span>
<span class="sd">        Tensor of predictive features for testing. Created in setup().</span>
<span class="sd">    own_early_stopping_callback : pytorch_lightning.callbacks.EarlyStopping</span>
<span class="sd">        Early stopping callback class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KFoldDataModule.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">fusion_model</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">subspace_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">layer_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">own_early_stopping_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        fusion_model : class</span>
<span class="sd">            Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            Batch size.</span>
<span class="sd">        subspace_method : class</span>
<span class="sd">            Subspace method class (default None) (only for subspace methods).</span>
<span class="sd">        image_downsample_size : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images. None if not downsampling. (default None)</span>
<span class="sd">        layer_mods : dict</span>
<span class="sd">            Dictionary of layer modifications to make to the subspace method.</span>
<span class="sd">            (default None)</span>
<span class="sd">        max_epochs : int</span>
<span class="sd">            Maximum number of epochs to train subspace methods for. (default 1000)</span>
<span class="sd">        extra_log_string_dict : dict</span>
<span class="sd">            Dictionary of extra strings to add to the log.</span>
<span class="sd">        own_early_stopping_callback : pytorch_lightning.callbacks.EarlyStopping</span>
<span class="sd">            Early stopping callback class (default None).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>  <span class="c1"># total number of folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_log_string_dict</span> <span class="o">=</span> <span class="n">extra_log_string_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;pred_type&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span> <span class="o">=</span> <span class="n">fusion_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subspace_method</span>  <span class="c1"># subspace method class (only for subspace methods)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">==</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiclass_dims</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;multiclass_dims&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiclass_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="o">=</span> <span class="n">layer_mods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">own_early_stopping_callback</span> <span class="o">=</span> <span class="n">own_early_stopping_callback</span></div>

<div class="viewcode-block" id="KFoldDataModule.prepare_data"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="KFoldDataModule.kfold_split"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.kfold_split">[docs]</a>    <span class="k">def</span> <span class="nf">kfold_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the dataset into k folds</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        folds : list</span>
<span class="sd">            List of tuples of (train_dataset, test_dataset)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># split the dataset into k folds</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get the indices of the dataset</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>

        <span class="n">folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="c1"># split the dataset into train and test sets for each fold</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">)</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span>

            <span class="c1"># append the train and test datasets to the folds list</span>
            <span class="n">folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">folds</span>  <span class="c1"># list of tuples of (train_dataset, test_dataset)</span></div>

<div class="viewcode-block" id="KFoldDataModule.setup"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the data into train and test sets, and runs the subspace method if specified</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        checkpoint_path : str</span>
<span class="sd">            Path to the checkpoint file for the subspace method (default None).</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        train_dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        val_dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfold_split</span><span class="p">()</span>  <span class="c1"># get the k folds from kfold_split() function</span>

        <span class="c1"># if subspace method is specified, run the subspace method on each fold</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if no checkpoint path specified, train the subspace method</span>
            <span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_folds</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">):</span>
                    <span class="c1"># get the train and test datasets for each fold</span>
                    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">fold</span>

                    <span class="c1">#  initialise the subspace method</span>
                    <span class="n">subspace_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                        <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                        <span class="n">train_subspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># modify the subspace method architecture if specified</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># if subspace method in layer_mods</span>
                        <span class="n">subspace_method</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                            <span class="n">subspace_method</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="c1"># train the subspace method and convert train dataset to the latent space</span>
                    <span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
                    <span class="p">)</span>

                    <span class="c1"># convert the test dataset to the latent space</span>
                    <span class="p">(</span>
                        <span class="n">test_latents</span><span class="p">,</span>
                        <span class="n">test_labels</span><span class="p">,</span>
                        <span class="n">data_dims</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

                    <span class="c1"># make a new CustomDataset with the latent features</span>
                    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
                    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>

                    <span class="n">new_folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
                    <span class="p">)</span>  <span class="c1"># append to new_folds</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">new_folds</span>  <span class="c1"># update the folds with the new train and test datasets</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span>  <span class="c1"># update the data dimensions</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># we have already trained the subspace method, so load it from the checkpoint</span>
                <span class="n">new_folds</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">):</span>
                    <span class="c1"># get the train and test datasets for each fold</span>
                    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">fold</span>

                    <span class="c1">#  initialise the subspace method</span>
                    <span class="n">subspace_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                        <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                        <span class="n">train_subspace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="c1"># checkpoint_path=checkpoint_path,</span>
                    <span class="p">)</span>

                    <span class="c1"># modify the subspace method architecture if specified</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># if subspace method in layer_mods</span>
                        <span class="n">subspace_method</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                            <span class="n">subspace_method</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">subspace_method</span><span class="o">.</span><span class="n">load_ckpt</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>

                    <span class="p">(</span>
                        <span class="n">train_latents</span><span class="p">,</span>
                        <span class="n">train_labels</span><span class="p">,</span>
                        <span class="n">data_dims</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

                    <span class="c1"># convert the test dataset to the latent space</span>
                    <span class="p">(</span>
                        <span class="n">test_latents</span><span class="p">,</span>
                        <span class="n">test_labels</span><span class="p">,</span>
                        <span class="n">data_dims</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">subspace_method</span><span class="o">.</span><span class="n">convert_to_latent</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

                    <span class="c1"># make a new CustomDataset with the latent features</span>
                    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">train_latents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
                    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">test_latents</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>

                    <span class="n">new_folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">new_folds</span>  <span class="c1"># update the folds with the new train and test datasets</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">data_dims</span>  <span class="c1"># update the data dimensions</span></div>

<div class="viewcode-block" id="KFoldDataModule.train_dataloader"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.train_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for training.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fold_idx : int</span>
<span class="sd">            Index of the fold to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="KFoldDataModule.val_dataloader"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldDataModule.val_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataloader for validation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fold_idx : int</span>
<span class="sd">            Index of the fold to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataloader : dataloader</span>
<span class="sd">            Dataloader for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="TrainTestGraphDataModule"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestGraphDataModule">[docs]</a><span class="k">class</span> <span class="nc">TrainTestGraphDataModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with graph data</span>
<span class="sd">    structure.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files.</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">        images.</span>
<span class="sd">    modality_methods : dict</span>
<span class="sd">        Dictionary of methods for loading the different modalities.</span>
<span class="sd">    fusion_model : class</span>
<span class="sd">        Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">    test_size : float</span>
<span class="sd">        Fraction of data to use for testing (default 0.2).</span>
<span class="sd">    graph_creation_method : class</span>
<span class="sd">        Graph creation method class.</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary of parameters.</span>
<span class="sd">    layer_mods : dict</span>
<span class="sd">        Dictionary of layer modifications to make to the graph maker method.</span>
<span class="sd">    dataset : tensor</span>
<span class="sd">        Tensor of predictive features. Created in prepare_data().</span>
<span class="sd">    data_dims : list</span>
<span class="sd">        List of data dimensions [mod1_dim, mod2_dim, img_dim]. Created in prepare_data().</span>
<span class="sd">    train_idxs : list</span>
<span class="sd">        List of indices for training. Created in setup().</span>
<span class="sd">    test_idxs : list</span>
<span class="sd">        List of indices for testing. Created in setup().</span>
<span class="sd">    graph_data : graph data structure</span>
<span class="sd">        Graph data structure. Created in setup().</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TrainTestGraphDataModule.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestGraphDataModule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">fusion_model</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="n">graph_creation_method</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">layer_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        fusion_model : class</span>
<span class="sd">            Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        graph_creation_method : class</span>
<span class="sd">            Graph creation method class.</span>
<span class="sd">        image_downsample_size : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images. None if not downsampling. (default None)</span>
<span class="sd">        layer_mods : dict</span>
<span class="sd">            Dictionary of layer modifications to make to the graph maker method.</span>
<span class="sd">            (default None)</span>
<span class="sd">        extra_log_string_dict : dict</span>
<span class="sd">            Dictionary of extra strings to add to the log.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_log_string_dict</span> <span class="o">=</span> <span class="n">extra_log_string_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span> <span class="o">=</span> <span class="n">fusion_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span> <span class="o">=</span> <span class="n">graph_creation_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="o">=</span> <span class="n">layer_mods</span></div>

<div class="viewcode-block" id="TrainTestGraphDataModule.prepare_data"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestGraphDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataset : tensor</span>
<span class="sd">            Tensor of predictive features.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">            i.e. [None, None, [100, 100, 100]] for image only (image dimensions 100 x 100 x 100)</span>
<span class="sd">            i.e. [8, 32, None] for tabular1 and tabular2 (tabular1 has 8 features, tabular2 has</span>
<span class="sd">            32 features), and no image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="TrainTestGraphDataModule.setup"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestGraphDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get random train and test idxs</span>
        <span class="p">[</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_idxs</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">indices</span>

        <span class="c1"># get the graph data structure</span>
        <span class="n">graph_maker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># modify the graph maker architecture if specified</span>
            <span class="n">graph_maker</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                <span class="n">graph_maker</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph_data</span> <span class="o">=</span> <span class="n">graph_maker</span><span class="o">.</span><span class="n">make_graph</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrainTestGraphDataModule.get_lightning_module"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.TrainTestGraphDataModule.get_lightning_module">[docs]</a>    <span class="k">def</span> <span class="nf">get_lightning_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        lightning_module : lightning module</span>
<span class="sd">            Lightning module for converting the graph data structure into a pytorch dataloader.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lightning_module</span> <span class="o">=</span> <span class="n">LightningNodeData</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_data</span><span class="p">,</span>
            <span class="n">input_train_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_idxs</span><span class="p">,</span>
            <span class="n">input_val_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">input_test_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">input_pred_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_idxs</span><span class="p">,</span>
            <span class="n">loader</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">lightning_module</span></div></div>


<div class="viewcode-block" id="KFoldGraphDataModule"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule">[docs]</a><span class="k">class</span> <span class="nc">KFoldGraphDataModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom pytorch lightning datamodule class for the different modalities with graph data</span>
<span class="sd">    structure and k-fold cross validation</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_folds : int</span>
<span class="sd">        Total number of folds.</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">        images.</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source csv files. [Tabular1, Tabular2, Image]</span>
<span class="sd">    modality_methods : dict</span>
<span class="sd">        Dictionary of methods for loading the different modalities.</span>
<span class="sd">    fusion_model : class</span>
<span class="sd">        Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">    graph_creation_method : class</span>
<span class="sd">        Graph creation method class.</span>
<span class="sd">    layer_mods : dict</span>
<span class="sd">        Dictionary of layer modifications to make to the graph maker method.</span>
<span class="sd">    dataset : tensor</span>
<span class="sd">        Tensor of predictive features.</span>
<span class="sd">    data_dims : list</span>
<span class="sd">        List of data dimensions [mod1_dim, mod2_dim, img_dim]</span>
<span class="sd">    folds : list</span>
<span class="sd">        List of tuples of (graph_data, train_idxs, test_idxs)</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KFoldGraphDataModule.__init__"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">fusion_model</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="n">graph_creation_method</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">layer_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of parameters.</span>
<span class="sd">        fusion_model : class</span>
<span class="sd">            Fusion model class. e.g. &quot;TabularCrossmodalAttention&quot;.</span>
<span class="sd">        sources : list</span>
<span class="sd">            List of source csv files.</span>
<span class="sd">        graph_creation_method : class</span>
<span class="sd">            Graph creation method class.</span>
<span class="sd">        image_downsample_size : tuple</span>
<span class="sd">            Size to downsample the images to (height, width, depth) or (height, width) for 2D</span>
<span class="sd">            images. None if not downsampling. (default None)</span>
<span class="sd">        layer_mods : dict</span>
<span class="sd">            Dictionary of layer modifications to make to the graph maker method.</span>
<span class="sd">            (default None)</span>
<span class="sd">        extra_log_string_dict : dict</span>
<span class="sd">            Dictionary of extra strings to add to the log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_k&quot;</span><span class="p">]</span>  <span class="c1"># total number of folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span> <span class="o">=</span> <span class="n">image_downsample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_log_string_dict</span> <span class="o">=</span> <span class="n">extra_log_string_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tabular1&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular1</span><span class="p">,</span>
            <span class="s2">&quot;tabular2&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tabular2</span><span class="p">,</span>
            <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span><span class="p">)</span><span class="o">.</span><span class="n">load_img</span><span class="p">,</span>
            <span class="s2">&quot;both_tab&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_both_tabular</span><span class="p">,</span>
            <span class="s2">&quot;tab_img&quot;</span><span class="p">:</span> <span class="n">LoadDatasets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_downsample_size</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_tab_and_img</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span> <span class="o">=</span> <span class="n">fusion_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">modality_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span> <span class="o">=</span> <span class="n">graph_creation_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="o">=</span> <span class="n">layer_mods</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.prepare_data"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data with LoadDatasets class</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modality_type</span><span class="p">]()</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.kfold_split"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule.kfold_split">[docs]</a>    <span class="k">def</span> <span class="nf">kfold_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the dataset into k folds</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        folds : list</span>
<span class="sd">            List of tuples of (graph_data, train_idxs, test_idxs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># splits the dataset into k folds</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>  <span class="c1"># get the indices of the dataset</span>

        <span class="n">folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="c1"># split the dataset into train and test sets for each fold</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">)</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span>
            <span class="n">folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># list of tuples of (train_dataset, test_dataset)</span>
        <span class="k">return</span> <span class="n">folds</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.setup"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets random train and test indices, and gets the graph data structure.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfold_split</span><span class="p">()</span>  <span class="c1"># get the k folds from kfold_split() function</span>

        <span class="n">new_folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">:</span>
            <span class="c1"># get the train and test datasets for each fold</span>
            <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">fold</span>
            <span class="n">train_idxs</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">indices</span>  <span class="c1"># get train node idxs from kfold_split()</span>
            <span class="n">test_idxs</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">indices</span>  <span class="c1"># get test node idxs from kfold_split()</span>

            <span class="c1"># get the graph data structure</span>
            <span class="n">graph_maker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_creation_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

            <span class="c1"># modify the graph maker architecture if specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph_maker</span> <span class="o">=</span> <span class="n">model_modifier</span><span class="o">.</span><span class="n">modify_model_architecture</span><span class="p">(</span>
                    <span class="n">graph_maker</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">layer_mods</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># make the graph data structure</span>
            <span class="n">graph_data</span> <span class="o">=</span> <span class="n">graph_maker</span><span class="o">.</span><span class="n">make_graph</span><span class="p">()</span>

            <span class="n">new_folds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">graph_data</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">folds</span> <span class="o">=</span> <span class="n">new_folds</span>  <span class="c1"># list of tuples of (graph_data, train_idxs, test_idxs)</span></div>

<div class="viewcode-block" id="KFoldGraphDataModule.get_lightning_module"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.KFoldGraphDataModule.get_lightning_module">[docs]</a>    <span class="k">def</span> <span class="nf">get_lightning_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the lightning module using the pytorch geometric lightning module for converting</span>
<span class="sd">        the graph data structure into a pytorch dataloader.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        lightning_modules : list</span>
<span class="sd">            List of lightning modules for each fold.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the normal lightning module using the pytorch geometric lightning module</span>

        <span class="n">lightning_modules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folds</span><span class="p">:</span>
            <span class="n">graph_data</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">test_idxs</span> <span class="o">=</span> <span class="n">fold</span>

            <span class="n">lightning_module</span> <span class="o">=</span> <span class="n">LightningNodeData</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">graph_data</span><span class="p">,</span>
                <span class="n">input_train_nodes</span><span class="o">=</span><span class="n">train_idxs</span><span class="p">,</span>
                <span class="n">input_val_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">input_test_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">input_pred_nodes</span><span class="o">=</span><span class="n">test_idxs</span><span class="p">,</span>
                <span class="n">loader</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">lightning_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lightning_module</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lightning_modules</span>  <span class="c1"># list of lightning modules for each fold</span></div></div>


<div class="viewcode-block" id="get_data_module"><a class="viewcode-back" href="../../autosummary/fusilli.data.html#fusilli.data.get_data_module">[docs]</a><span class="k">def</span> <span class="nf">get_data_module</span><span class="p">(</span>
        <span class="n">fusion_model</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">image_downsample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layer_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">optional_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">own_early_stopping_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the data module for a specific fusion model and training protocol.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fusion_model : class</span>
<span class="sd">        Fusion model class.</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary of parameters.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Batch size (default 8).</span>
<span class="sd">    image_downsample_size : tuple</span>
<span class="sd">        Tuple of image dimensions to downsample to (default None).</span>
<span class="sd">        e.g. (100, 100, 100) for 3D images, (100, 100) for 2D images.</span>
<span class="sd">    layer_mods : dict</span>
<span class="sd">        Dictionary of layer modifications (default None).</span>
<span class="sd">    max_epochs : int</span>
<span class="sd">        Maximum number of epochs to train subspace methods for. (default 1000)</span>
<span class="sd">    optional_suffix : str</span>
<span class="sd">        Optional suffix added to data source file names (default None).</span>
<span class="sd">    checkpoint_path : list</span>
<span class="sd">        List containing paths to call checkpoint file. Length of the list is the number of trainable subspace models</span>
<span class="sd">        in the fusion model (e.g., DAETabImgMaps requires two models to be pre-trained, so we&#39;d pass 2 checkpoint</span>
<span class="sd">        paths in the list. (default None will result in the default lightning format).</span>
<span class="sd">    extra_log_string_dict : dict</span>
<span class="sd">        Dictionary of extra strings to add to a subspace method checkpoint file name (default None).</span>
<span class="sd">        e.g. if you&#39;re running the same model with different hyperparameters, you can add the hyperparameters.</span>
<span class="sd">        Input format {&quot;name&quot;: &quot;value&quot;}. In the run name, the extra string will be added</span>
<span class="sd">        as &quot;name_value&quot;. And a tag will be added as &quot;name_value&quot;.</span>
<span class="sd">        Default None.</span>
<span class="sd">    own_early_stopping_callback : pytorch_lightning.callbacks.EarlyStopping</span>
<span class="sd">        Early stopping callback class (default None).</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dm : datamodule</span>
<span class="sd">        Datamodule for the specified fusion method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_sources</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tabular1_source</span><span class="si">{</span><span class="n">optional_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tabular2_source</span><span class="si">{</span><span class="n">optional_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;img_source</span><span class="si">{</span><span class="n">optional_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fusion_model</span><span class="p">,</span> <span class="s2">&quot;subspace_method&quot;</span><span class="p">):</span>
        <span class="n">fusion_model</span><span class="o">.</span><span class="n">subspace_method</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">fusion_model</span><span class="o">.</span><span class="n">fusion_type</span> <span class="o">==</span> <span class="s2">&quot;graph&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="n">graph_data_module</span> <span class="o">=</span> <span class="n">KFoldGraphDataModule</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">fusion_model</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
                <span class="n">graph_creation_method</span><span class="o">=</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">graph_maker</span><span class="p">,</span>
                <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
                <span class="n">layer_mods</span><span class="o">=</span><span class="n">layer_mods</span><span class="p">,</span>
                <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="n">extra_log_string_dict</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_data_module</span> <span class="o">=</span> <span class="n">TrainTestGraphDataModule</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">fusion_model</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
                <span class="n">graph_creation_method</span><span class="o">=</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">graph_maker</span><span class="p">,</span>
                <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
                <span class="n">layer_mods</span><span class="o">=</span><span class="n">layer_mods</span><span class="p">,</span>
                <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="n">extra_log_string_dict</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">graph_data_module</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">graph_data_module</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">data_module</span> <span class="o">=</span> <span class="n">graph_data_module</span><span class="o">.</span><span class="n">get_lightning_module</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="c1"># if kfold, then we have a list of lightning modules</span>
            <span class="c1"># so we need to set the data dimensions for each lightning module</span>
            <span class="k">for</span> <span class="n">dm_instance</span> <span class="ow">in</span> <span class="n">data_module</span><span class="p">:</span>
                <span class="n">dm_instance</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">graph_data_module</span><span class="o">.</span><span class="n">data_dims</span>
                <span class="n">dm_instance</span><span class="o">.</span><span class="n">own_early_stopping_callback</span> <span class="o">=</span> <span class="n">own_early_stopping_callback</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_module</span><span class="o">.</span><span class="n">data_dims</span> <span class="o">=</span> <span class="n">graph_data_module</span><span class="o">.</span><span class="n">data_dims</span>
            <span class="n">data_module</span><span class="o">.</span><span class="n">own_early_stopping_callback</span> <span class="o">=</span> <span class="n">own_early_stopping_callback</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># another other than graph fusion</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kfold_flag&quot;</span><span class="p">]:</span>
            <span class="n">datamodule_func</span> <span class="o">=</span> <span class="n">KFoldDataModule</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datamodule_func</span> <span class="o">=</span> <span class="n">TrainTestDataModule</span>

        <span class="n">data_module</span> <span class="o">=</span> <span class="n">datamodule_func</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">fusion_model</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">,</span>
            <span class="n">subspace_method</span><span class="o">=</span><span class="n">fusion_model</span><span class="o">.</span><span class="n">subspace_method</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">image_downsample_size</span><span class="o">=</span><span class="n">image_downsample_size</span><span class="p">,</span>
            <span class="n">layer_mods</span><span class="o">=</span><span class="n">layer_mods</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>
            <span class="n">extra_log_string_dict</span><span class="o">=</span><span class="n">extra_log_string_dict</span><span class="p">,</span>
            <span class="n">own_early_stopping_callback</span><span class="o">=</span><span class="n">own_early_stopping_callback</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_module</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">data_module</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_module</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Florence J Townend.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>