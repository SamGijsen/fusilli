<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fusion Model Template: Subspace-based Fusion &mdash; fusilli  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../_static/florencestheme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/pink_pasta_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fusion Model Template: Graph-based Fusion" href="template_graph_fusion.html" />
    <link rel="prev" title="How to create your own fusion model: a general template" href="A_template_other_fusion.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fusilli
              <img src="../_static/pink_pasta_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">üå∏ Table of Contents üå∏</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html"><strong>fusilli</strong>: an introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fusion_model_explanations.html">Fusion Model Explanations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modifying_models.html">Modifying the fusion models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üå∏ Tutorials üå∏</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/training_and_testing/index.html">Training and testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/customising_behaviour/index.html">Customising behaviour</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üå∏ How to contribute üå∏</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Fusion Model Templates</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="A_template_other_fusion.html">How to create your own fusion model: a general template</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fusion Model Template: Subspace-based Fusion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#option-1-simultaneously-trained-subspace-based-fusion-model">Option 1: Simultaneously-trained subspace-based fusion model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#option-2-pre-trained-subspace-based-fusion-model">Option 2: Pre-trained subspace-based fusion model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step-1-create-the-pytorch-lightning-subspace-model">Step 1: Create the PyTorch Lightning subspace model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-create-the-class-with-the-methods-load-ckpt-train-and-convert-to-latent">Step 2: create the class with the methods <code class="docutils literal notranslate"><span class="pre">load_ckpt</span></code>, <code class="docutils literal notranslate"><span class="pre">train</span></code>, and <code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-3-create-the-fusion-model-class">Step 3: create the fusion model class</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="template_graph_fusion.html">Fusion Model Template: Graph-based Fusion</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üå∏ API Reference üå∏</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.fusionmodels.html">fusilli.fusionmodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.data.html">fusilli.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.train.html">fusilli.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.eval.html">fusilli.eval</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.utils.html">fusilli.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fusilli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Fusion Model Templates</a></li>
      <li class="breadcrumb-item active">Fusion Model Template: Subspace-based Fusion</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/contributing_examples/plot_template_subspace_fusion.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-contributing-examples-plot-template-subspace-fusion-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="fusion-model-template-subspace-based-fusion">
<span id="sphx-glr-contributing-examples-plot-template-subspace-fusion-py"></span><h1>Fusion Model Template: Subspace-based Fusion<a class="headerlink" href="#fusion-model-template-subspace-based-fusion" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>This tutorial will show you how to create a subspace-based fusion model.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I recommend looking at <a class="reference internal" href="A_template_other_fusion.html#how-to-contribute-a-template-other-fusion"><span class="std std-ref">How to create your own fusion model: a general template</span></a> before looking at this template, as I will skip over some of the details that are covered in that template (particularly regarding documentation and idiosyncrasies of the fusion model template).</p>
</div>
<p>There are <strong>two</strong> types of subspace-based fusion models in this library:</p>
<ol class="arabic simple">
<li><p>A model that has subspace methods trained <strong>before</strong> the main prediction model. An example of this is <code class="xref py py-class docutils literal notranslate"><span class="pre">DAETabImgMaps</span></code>. This works by training the subspace method first, then using the output of the subspace method as the input to the main prediction model.</p></li>
<li><p>A model that has subspace methods (such as an autoencoder) trained <strong>simultaneously</strong> with the main prediction model. An example of this is <a class="reference internal" href="../autosummary/fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubleloss.html#fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubleloss.ConcatImgLatentTabDoubleLoss" title="fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubleloss.ConcatImgLatentTabDoubleLoss"><code class="xref py py-class docutils literal notranslate"><span class="pre">ConcatImgLatentTabDoubleLoss</span></code></a>. This works by implementing a joint loss function that combines the loss of the subspace method and the loss of the main prediction model.</p></li>
</ol>
<p>We will look at how to create both of these types of models.</p>
<section id="option-1-simultaneously-trained-subspace-based-fusion-model">
<h2>Option 1: Simultaneously-trained subspace-based fusion model<a class="headerlink" href="#option-1-simultaneously-trained-subspace-based-fusion-model" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>There are two differences between this type of model and the general template in <a class="reference internal" href="A_template_other_fusion.html#how-to-contribute-a-template-other-fusion"><span class="std std-ref">How to create your own fusion model: a general template</span></a>:</p>
<ul class="simple">
<li><p>Must have the attribute <code class="docutils literal notranslate"><span class="pre">self.custom_loss</span></code> which is the loss function used to train the subspace method (e.g. the MSELoss for an autoencoder).</p></li>
<li><p>Must output the subspace method‚Äôs output in the <code class="docutils literal notranslate"><span class="pre">forward</span></code> method as the second list element e.g. output = [prediction, reconstruction]</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using custom loss is currently only implemented if the <strong>second modality is the reconstructed modality</strong>, e.g. the image in tabular-image fusion, or the second tabular modality in tabular-tabular fusion.</p>
<p>The reconstruction shape <strong>must</strong> be the same as the input shape.</p>
</div>
<p>Here is a diagram of an example of a simultaneously-trained subspace-based fusion model:</p>
<img alt="../_images/simultaneous_train.png" src="../_images/simultaneous_train.png" />
<p>And here is the code for the model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">lightning.pytorch</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">fusilli.fusionmodels.base_model</span> <span class="kn">import</span> <span class="n">ParentFusionModel</span>


<span class="k">class</span> <span class="nc">TemplateSubspaceFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Template for a subspace-based fusion model that has the subspace method trained before the main prediction model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template Subspace Fusion Model&quot;</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;subspace&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="c1"># nn.Module: Subspace method for the second modality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span> <span class="mi">480</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">220</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">88</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="mi">220</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">480</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">750</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># nn.Module: Prediction layers.</span>
        <span class="c1"># Concatenating the subspace method&#39;s output with the first tabular modality data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">88</span> <span class="o">+</span> <span class="n">data_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_pred_layers</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># nn.Module: Custom loss function for the reconstruction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : list</span>
<span class="sd">            List of modalities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of outputs from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tabular_1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tabular_2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get the subspace method&#39;s output</span>
        <span class="n">subspace_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_downsample</span><span class="p">(</span><span class="n">tabular_2</span><span class="p">)</span>
        <span class="n">subspace_reconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_method_upsample</span><span class="p">(</span><span class="n">subspace_output</span><span class="p">)</span>

        <span class="c1"># get the prediction model&#39;s output (concatenating the subspace method&#39;s output with the tabular data)</span>
        <span class="n">out_fused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">tabular_1</span><span class="p">,</span> <span class="n">subspace_output</span><span class="p">]))</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction</span><span class="p">(</span><span class="n">out_fused</span><span class="p">)</span>

        <span class="c1"># returning the subspace method&#39;s output as the second list element</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prediction</span><span class="p">,</span> <span class="n">subspace_reconstruction</span><span class="p">]</span>
</pre></div>
</div>
<p>Now that we‚Äôve got the basic structure of the model, there is one additional thing to consider:</p>
<p><strong>Can the model be modified?</strong></p>
<p>For the most user flexibility, the model attributes should be able to be modified (such as the subspace method layers) and the model should be able to recalculate the layers of the model if the attributes are modified.</p>
<p><strong>For more information on this, see Step 3 in :ref:`how_to_contribute_a_template_other_fusion`.</strong></p>
</section>
<hr class="docutils" />
<section id="option-2-pre-trained-subspace-based-fusion-model">
<h2>Option 2: Pre-trained subspace-based fusion model<a class="headerlink" href="#option-2-pre-trained-subspace-based-fusion-model" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>This section will show how to create susbapce-based fusion model which involves one or more models that have to be pre-trained.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.py</span></code> file that contains the whole fusion model must have the following three things:</p>
<ol class="arabic simple">
<li><p>A PyTorch Lightning module which contains the subspace model architecture, e.g. <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">TemplateSubspaceModel(pl.LightningModule):</span></code></p></li>
<li><p>A class with the methods <code class="docutils literal notranslate"><span class="pre">load_ckpt</span></code>, <code class="docutils literal notranslate"><span class="pre">train</span></code>, and <code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code>, which are used to load the pre-trained model, train a latent space, and convert data to a latent space respectively. These are called when the data for the fusion model is loaded in <a class="reference internal" href="../autosummary/fusilli.data.html#fusilli.data.get_data_module" title="fusilli.data.get_data_module"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_data_module()</span></code></a>.</p></li>
<li><p>The fusion model class which contains the main prediction model architecture, e.g. <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">TemplateSubspaceFusionModel(ParentFusionModel,</span> <span class="pre">nn.Module):</span></code> Similar to a general fusion model, this must have the methods <code class="docutils literal notranslate"><span class="pre">__init__</span></code>, <code class="docutils literal notranslate"><span class="pre">calc_fused_layers</span></code>, and <code class="docutils literal notranslate"><span class="pre">forward</span></code>.</p></li>
</ol>
<p>This is a diagram of an example of a pre-trained subspace-based fusion model:</p>
<img alt="../_images/pretrain_subspace_diagram.png" src="../_images/pretrain_subspace_diagram.png" />
<p>Let‚Äôs go through each of these in detail.</p>
<section id="step-1-create-the-pytorch-lightning-subspace-model">
<h3>Step 1: Create the PyTorch Lightning subspace model<a class="headerlink" href="#step-1-create-the-pytorch-lightning-subspace-model" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Might be useful to familiarise yourself with the pytorch lightning module first.</p>
<p>Methods that must have specific names:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: initialising with input parameters <code class="docutils literal notranslate"><span class="pre">data_dims</span></code> and any other parameters that are needed for the model and accessible from the <code class="docutils literal notranslate"><span class="pre">params</span></code> dictionary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forward</span></code>: the forward pass of the model. Takes <code class="docutils literal notranslate"><span class="pre">x</span></code> as input. Must be modifiable (see Step 3 in <a class="reference internal" href="A_template_other_fusion.html#how-to-contribute-a-template-other-fusion"><span class="std std-ref">How to create your own fusion model: a general template</span></a>) for details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">training_step</span></code>: the training step of the model. Takes <code class="docutils literal notranslate"><span class="pre">batch</span></code> and <code class="docutils literal notranslate"><span class="pre">batch_idx</span></code> as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validation_step</span></code>: the validation step of the model. Takes <code class="docutils literal notranslate"><span class="pre">batch</span></code> and <code class="docutils literal notranslate"><span class="pre">batch_idx</span></code> as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">configure_optimizers</span></code>: the optimiser of the model.</p></li>
</ul>
<p>Methods that can have any name:</p>
<ul class="simple">
<li><p>A method that gets the latent space of the model from the input data, e.g. <code class="docutils literal notranslate"><span class="pre">encode_image</span></code> for an autoencoder with an image input. In our example, this is <code class="docutils literal notranslate"><span class="pre">get_latent_rep</span></code>.</p></li>
</ul>
<p>Here‚Äôs an example of a model with a simple 2-layer autoencoder to get the latent space of the tabular data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateSubspaceModel</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplateSubspaceModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tab_shape</span> <span class="o">=</span> <span class="n">data_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_shape</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_latent_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-2-create-the-class-with-the-methods-load-ckpt-train-and-convert-to-latent">
<h3>Step 2: create the class with the methods <code class="docutils literal notranslate"><span class="pre">load_ckpt</span></code>, <code class="docutils literal notranslate"><span class="pre">train</span></code>, and <code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code><a class="headerlink" href="#step-2-create-the-class-with-the-methods-load-ckpt-train-and-convert-to-latent" title="Permalink to this heading">ÔÉÅ</a></h3>
<p><strong>Must have</strong> a class attribute (defined before the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method) <code class="docutils literal notranslate"><span class="pre">subspace_models</span></code>: a list of the subspace model classes.</p>
<p>For our example, <code class="docutils literal notranslate"><span class="pre">subspace_methods</span> <span class="pre">=</span> <span class="pre">[TemplateSubspaceModel]</span></code>.</p>
<p>Must have the following methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: initialising with input parameters <code class="docutils literal notranslate"><span class="pre">datamodule</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span></code>, <code class="docutils literal notranslate"><span class="pre">max_epochs</span></code>, and <code class="docutils literal notranslate"><span class="pre">train_subspace</span></code>. For detailed documentation, see <a class="reference internal" href="../autosummary/fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubletrain.html#fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubletrain.concat_img_latent_tab_subspace_method" title="fusilli.fusionmodels.tabularimagefusion.concat_img_latent_tab_doubletrain.concat_img_latent_tab_subspace_method"><code class="xref py py-class docutils literal notranslate"><span class="pre">concat_img_latent_tab_subspace_method</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_ckpt</span></code>: loading the pre-trained model. Takes <code class="docutils literal notranslate"><span class="pre">checkpoint_path</span></code> as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train</span></code>: training the latent space. Takes <code class="docutils literal notranslate"><span class="pre">train_dataset</span></code> and <code class="docutils literal notranslate"><span class="pre">val_dataset</span></code> as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code>: converting the data to a latent space. Takes <code class="docutils literal notranslate"><span class="pre">test_dataset</span></code> as input.</p></li>
</ul>
<p>Let‚Äôs create the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method first.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">datamodule</span></code> parameter is the data module that is created in <a class="reference internal" href="../autosummary/fusilli.data.html#fusilli.data.get_data_module" title="fusilli.data.get_data_module"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_data_module()</span></code></a>. This is used to get the data for the subspace method.</p>
</div></blockquote>
<p>The input arguments that we need are <code class="docutils literal notranslate"><span class="pre">datamodule</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span></code>, <code class="docutils literal notranslate"><span class="pre">max_epochs</span></code>, and <code class="docutils literal notranslate"><span class="pre">train_subspace</span></code>. These are all passed to this method during <a class="reference internal" href="../autosummary/fusilli.data.html#fusilli.data.get_data_module" title="fusilli.data.get_data_module"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_data_module()</span></code></a>, so we need to make sure that we have these as input arguments.</p>
</div>
<p>A couple things need to happen in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<ol class="arabic simple">
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">datamodule</span></code> attribute to the input <code class="docutils literal notranslate"><span class="pre">datamodule</span></code>. This is accessed during utilities relating to checkpointing.</p></li>
<li><p>The subspace model, <code class="docutils literal notranslate"><span class="pre">TemplateSubspaceModel</span></code>, must be initialised. This is done by calling <code class="docutils literal notranslate"><span class="pre">self.subspace_models[0]</span></code>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">train_subspace</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, then the subspace model must be trained. This means that we need to:</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Get the appropriate checkpoint path for the subspace model. This is done by calling <a class="reference internal" href="../autosummary/fusilli.utils.training_utils.html#fusilli.utils.training_utils.get_checkpoint_filenames_for_subspace_models" title="fusilli.utils.training_utils.get_checkpoint_filenames_for_subspace_models"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_checkpoint_filenames_for_subspace_models()</span></code></a>.</p></li>
<li><p>Initialise a PyTorch Lightning trainer using <a class="reference internal" href="../autosummary/fusilli.utils.training_utils.html#fusilli.utils.training_utils.init_trainer" title="fusilli.utils.training_utils.init_trainer"><code class="xref py py-func docutils literal notranslate"><span class="pre">init_trainer()</span></code></a>.</p></li>
</ol>
</div></blockquote>
<p>Here‚Äôs an example of the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fusilli.utils.training_utils</span> <span class="kn">import</span> <span class="n">get_checkpoint_filenames_for_subspace_models</span><span class="p">,</span> <span class="n">init_trainer</span>


<span class="k">class</span> <span class="nc">TemplateSubspaceMethod</span><span class="p">:</span>
    <span class="n">subspace_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">TemplateSubspaceModel</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datamodule</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">train_subspace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span> <span class="o">=</span> <span class="n">datamodule</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subspace_models</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">datamodule</span><span class="o">.</span><span class="n">data_dims</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">train_subspace</span><span class="p">:</span>
            <span class="n">autoencoder_ckpt_list</span> <span class="o">=</span> <span class="n">get_checkpoint_filenames_for_subspace_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="c1"># returns a list of checkpoint paths for the subspace model (length 1 for our example)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">init_trainer</span><span class="p">(</span>
                <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># no logger for the subspace models</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>  <span class="c1"># pass in the params dictionary stored in the datamodule</span>
                <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>  <span class="c1"># max_epochs is an input argument</span>
                <span class="n">checkpoint_filename</span><span class="o">=</span><span class="n">autoencoder_ckpt_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># checkpoint_filename is the first element of the list</span>
            <span class="p">)</span>

    <span class="c1"># %%</span>
    <span class="c1"># Now let&#39;s create the ``load_ckpt`` method. This is called when we have already trained the subspace model and we are passing new data through the model, such as in :func:`~.RealsVsPreds.from_new_data`.</span>
    <span class="c1">#</span>
    <span class="c1"># The ``state_dict`` of the model must be loaded from the checkpoint.</span>

    <span class="c1"># ... continuing from the previous code snippet ...</span>

    <span class="k">def</span> <span class="nf">load_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Onto the <code class="docutils literal notranslate"><span class="pre">train</span></code> method.</p>
<p>The following must happen in this method:</p>
<ol class="arabic simple">
<li><p>The data will be input as train and validation datasets and these need to be converted to dataloaders.</p></li>
<li><p>The model will be trained and tested by calling <code class="docutils literal notranslate"><span class="pre">.fit</span></code> and <code class="docutils literal notranslate"><span class="pre">.validate()</span></code> on the trainer.</p></li>
<li><p>The latent space of the train data will be calculated by calling <code class="docutils literal notranslate"><span class="pre">.get_latent_rep</span></code> on the model.</p></li>
<li><p>The new train data will be returned as a list of length 2: <code class="docutils literal notranslate"><span class="pre">[the</span> <span class="pre">predictive</span> <span class="pre">train</span> <span class="pre">features,</span> <span class="pre">pandas</span> <span class="pre">dataframe</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">train</span> <span class="pre">labels]</span></code>.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be careful not to get your train and test data mixed up! Both have to be converted to the latent space but only the train dataset should be used in <code class="docutils literal notranslate"><span class="pre">.fit()</span></code></p>
</div>
<p>Here‚Äôs an example of the <code class="docutils literal notranslate"><span class="pre">train</span></code> method for our example, where the second tabular modality is being converted to a latent space to be our new second tabular modality:
e.g. [tab1, tab2] -&gt; [tab1, tab2_latent]</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># imports for the train method</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>


<span class="c1"># ... continuing from the previous code snippet ...</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">):</span>
    <span class="n">tabular1_train_features</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[:][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tabular2_train_features</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[:][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[:][</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">tabular1_val_features</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="p">[:][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tabular2_val_features</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="p">[:][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">val_labels</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="p">[:][</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># setting dataloaders for the train and validation datasets of tabular 2</span>
    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">tabular2_train_features</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># customise</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">tabular2_val_features</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># customise</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># training the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">)</span>

    <span class="c1"># validating the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">)</span>

    <span class="c1"># setting the model to evaluation mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># getting the latent space of the train data</span>
    <span class="n">tabular2_train_features_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_latent_rep</span><span class="p">(</span><span class="n">tabular2_train_features</span><span class="p">)</span>

    <span class="c1"># returning the new train data</span>
    <span class="n">new_pred_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">tabular1_train_features</span><span class="p">,</span> <span class="n">tabular2_train_features_latent</span><span class="p">]</span>
    <span class="n">label_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">train_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pred_label&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">new_pred_features</span><span class="p">,</span> <span class="n">label_dataframe</span><span class="p">]</span>
</pre></div>
</div>
<p>Finally, let‚Äôs create the <code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code> method.
This is similar to the <code class="docutils literal notranslate"><span class="pre">train</span></code> method, except that we don‚Äôt need to train the model, only convert the input data to the already-trained latent space.</p>
<p>We will return the list, like in the <code class="docutils literal notranslate"><span class="pre">train</span></code> method, but this time there will be an additional element in the list: the list of data dimensions <code class="docutils literal notranslate"><span class="pre">[tab1_dim,</span> <span class="pre">tab2_dim,</span> <span class="pre">img_dim]</span></code>.</p>
<p>In our example‚Äôs case, the data dimensions would be <code class="docutils literal notranslate"><span class="pre">[tab1_dim,</span> <span class="pre">tab2_latent_dim,</span> <span class="pre">None]</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... continuing from the previous code snippet ...</span>
<span class="k">def</span> <span class="nf">convert_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="step-3-create-the-fusion-model-class">
<h3>Step 3: create the fusion model class<a class="headerlink" href="#step-3-create-the-fusion-model-class" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Very similar to the general fusion model template in <a class="reference internal" href="A_template_other_fusion.html#how-to-contribute-a-template-other-fusion"><span class="std std-ref">How to create your own fusion model: a general template</span></a>.</p>
<p>Biggest difference is that we have an additional class-level attribute <code class="docutils literal notranslate"><span class="pre">subspace_method</span></code>, which points to the class that we created in Step 2.</p>
<p>This fusion model will use the data from <code class="docutils literal notranslate"><span class="pre">convert_to_latent</span></code> in Step 2, not the original input data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateSubspaceFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template Subspace Fusion Model - with pre-trained subspace method&quot;</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;subspace&quot;</span>

    <span class="c1"># class-level attribute pointing to the subspace method class</span>
    <span class="n">subspace_method</span> <span class="o">=</span> <span class="n">TemplateSubspaceMethod</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="c1"># nn.Module: Prediction layers concatenating the latent space with the tabular data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">data_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># setting the final prediction layers based on the prediction type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_pred_layers</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">tabular_1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tabular_2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get the prediction model&#39;s output (concatenating the latent space with the tabular data)</span>
        <span class="n">out_fused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">tabular_1</span><span class="p">,</span> <span class="n">tabular_2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># get the final prediction</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction</span><span class="p">(</span><span class="n">out_fused</span><span class="p">)</span>

        <span class="c1"># returning the prediction as the first list element</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prediction</span><span class="p">,</span> <span class="p">]</span>
</pre></div>
</div>
<p>As with the simultaneously-trained subspace-based fusion model, we need to think about:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Can the model be modified?</strong></p>
<p>For the most user flexibility, the model attributes should be able to be modified (such as the subspace method layers) and the model should be able to recalculate the layers of the model if the attributes are modified.</p>
<p>For more information on this, see Step 3 in <a class="reference internal" href="A_template_other_fusion.html#how-to-contribute-a-template-other-fusion"><span class="std std-ref">How to create your own fusion model: a general template</span></a>.</p>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.011 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-contributing-examples-plot-template-subspace-fusion-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/dbe4504fdbd000b44c4ae304996b55eb/plot_template_subspace_fusion.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_template_subspace_fusion.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/72d8d8725d87131b4b55661405be2fdd/plot_template_subspace_fusion.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_template_subspace_fusion.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="A_template_other_fusion.html" class="btn btn-neutral float-left" title="How to create your own fusion model: a general template" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="template_graph_fusion.html" class="btn btn-neutral float-right" title="Fusion Model Template: Graph-based Fusion" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Florence J Townend.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>