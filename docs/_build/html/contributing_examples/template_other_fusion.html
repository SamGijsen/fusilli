<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to create your own fusion model &mdash; fusilli  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="../_static/florencestheme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/pink_pasta_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fusilli
              <img src="../_static/pink_pasta_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">🌸 Table of Contents 🌸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html"><strong>fusilli</strong>: an introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User guide (installation, data requirements, etc.)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">How to quick-run Fusilli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fusion_model_explanations.html">The fusion models: diagrams and explanations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modifying_models.html">How to modify the fusion models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact_me.html">Contact me</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🌸 Tutorials 🌸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/training_and_testing/index.html">Training and testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/customising_behaviour/index.html">Customising behaviour</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🌸 How to contribute 🌸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Fusion Model Templates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🌸 API Reference 🌸</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.fusionmodels.html">fusilli.fusionmodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.data.html">fusilli.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.train.html">fusilli.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.eval.html">fusilli.eval</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autosummary/fusilli.utils.html">fusilli.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fusilli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How to create your own fusion model</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/contributing_examples/template_other_fusion.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-contributing-examples-template-other-fusion-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="how-to-create-your-own-fusion-model">
<span id="sphx-glr-contributing-examples-template-other-fusion-py"></span><h1>How to create your own fusion model<a class="headerlink" href="#how-to-create-your-own-fusion-model" title="Permalink to this heading"></a></h1>
<p>I want to create my own fusion model! Does this sound like you? Then this is the template for you! ✨✨✨</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Is this the correct template for you?</strong></p>
<p>If you want to implement a graph-based or subspace-based fusion model, please refer to the other templates.</p>
<p>You’ll know if you need to use them if the input into the model you’re implementing can’t be represented as a tuple of tensors of the original input data (modality1, modality2).</p>
<p>For example:</p>
<ul class="simple">
<li><p>If you’re implementing a graph-based fusion model, the input into the model is a graph, not a tuple of tensors.</p></li>
<li><p>If you’re implementing a subspace-based fusion model, the input into the model might be a latent space from a VAE trained on the original input data, not the original input data itself.</p></li>
</ul>
</div>
<section id="step-1-importing-the-libraries">
<h2>Step 1: Importing the libraries<a class="headerlink" href="#step-1-importing-the-libraries" title="Permalink to this heading"></a></h2>
<p>Let’s import the libraries we need to create our model. Because we’re using PyTorch, we need to import the PyTorch libraries
as well as the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class and functions to help with checking model conditions and validity in the <a class="reference internal" href="../autosummary/fusilli.utils.check_model_validity.html#module-fusilli.utils.check_model_validity" title="fusilli.utils.check_model_validity"><code class="xref py py-mod docutils literal notranslate"><span class="pre">check_model_validity</span></code></a> module.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># importing the parent fusion model class</span>
<span class="kn">from</span> <span class="nn">fusilli.fusionmodels.base_model</span> <span class="kn">import</span> <span class="n">ParentFusionModel</span>

<span class="c1"># importing functions to help with checking model conditions and validity</span>
<span class="kn">from</span> <span class="nn">fusilli.utils</span> <span class="kn">import</span> <span class="n">check_model_validity</span>
</pre></div>
</div>
</section>
<section id="step-2-creating-the-model-structure">
<h2>Step 2: Creating the model structure<a class="headerlink" href="#step-2-creating-the-model-structure" title="Permalink to this heading"></a></h2>
<section id="step-2-1-creating-the-class">
<h3><strong>Step 2.1: Creating the class</strong><a class="headerlink" href="#step-2-1-creating-the-class" title="Permalink to this heading"></a></h3>
<p>Let’s create the class for our model. We’ll call it <code class="docutils literal notranslate"><span class="pre">TemplateFusionModel</span></code>. This class will inherit from the
<a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class and the <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code> class. This is because we want to inherit the
methods and attributes from the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class and we want to make sure that our model is a
PyTorch model.</p>
<p><a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> has 3 input arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pred_type</span></code> : a string telling the model what type of prediction to perform. This is specified by the user in their python script or notebook.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_dims</span></code> : a list of the dimensions of the input data. This is calculated by <a class="reference internal" href="../autosummary/fusilli.data.html#fusilli.data.get_data_module" title="fusilli.data.get_data_module"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_data_module()</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code> : a dictionary containing the parameters of the model. This is specified by the user in their python script or notebook.</p></li>
</ul>
<p>These input arguments have to be passed into the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function of our fusion model. When running this library, this is done automatically for you in
the <a class="reference internal" href="../autosummary/fusilli.train.html#fusilli.train.train_and_save_models" title="fusilli.train.train_and_save_models"><code class="xref py py-func docutils literal notranslate"><span class="pre">train_and_save_models()</span></code></a> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="step-2-2-setting-the-model-attributes">
<h3><strong>Step 2.2: Setting the model attributes</strong><a class="headerlink" href="#step-2-2-setting-the-model-attributes" title="Permalink to this heading"></a></h3>
<p>Each model has to have the following attributes at the class level (i.e. outside of the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function and accessable without having to call <code class="docutils literal notranslate"><span class="pre">TemplateFusionModel()</span></code>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">method_name</span></code> : a string of the method name. This can be a better description of the method than the class name. For example, the class name might be <code class="docutils literal notranslate"><span class="pre">ConcatTabularData</span></code> but the method name might be <code class="docutils literal notranslate"><span class="pre">Concatenation</span> <span class="pre">of</span> <span class="pre">tabular</span> <span class="pre">data</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modality_type</span></code> : a string containing the type of modality, which is one of the following: <code class="docutils literal notranslate"><span class="pre">tabular1</span></code>, <code class="docutils literal notranslate"><span class="pre">tabular2</span></code>, <code class="docutils literal notranslate"><span class="pre">both_tab</span></code>, <code class="docutils literal notranslate"><span class="pre">tab_img</span></code>, <code class="docutils literal notranslate"><span class="pre">img</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fusion_type</span></code> : a string containing the type of fusion, which is one of the following: <code class="docutils literal notranslate"><span class="pre">operation</span></code>, <code class="docutils literal notranslate"><span class="pre">attention</span></code>, <code class="docutils literal notranslate"><span class="pre">tensor</span></code>, <code class="docutils literal notranslate"><span class="pre">graph</span></code>, <code class="docutils literal notranslate"><span class="pre">subspace</span></code>. To find out more about the different types of fusion, please refer to the <a class="reference internal" href="../fusion_model_explanations.html#fusion-model-explanations"><span class="std std-ref">The fusion models: diagrams and explanations</span></a> section.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The comment above the class attributes lets the attributes be documented automatically by Sphinx. This is why the comment is formatted in a specific way.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># str: name of the method</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template fusion model&quot;</span>
    <span class="c1"># str: modality type</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>  <span class="c1"># or &quot;tabular1&quot;, &quot;tabular2&quot;, &quot;both_tab&quot;, &quot;tab_img&quot;, &quot;img&quot;</span>
    <span class="c1"># str: fusion type</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;attention&quot;</span>  <span class="c1"># or &quot;operation&quot;, &quot;tensor&quot;, &quot;graph&quot;, &quot;subspace&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="step-2-3-setting-the-model-layers">
<h3><strong>Step 2.3: Setting the model layers</strong><a class="headerlink" href="#step-2-3-setting-the-model-layers" title="Permalink to this heading"></a></h3>
<p>Now we need to set the layers of the model. This is done in the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function of the model.</p>
<p>There are two ways to set the layers of the model:</p>
<ol class="arabic simple">
<li><p>You can use the preset layers in the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class. This is the easiest way to create your own fusion model. You can see an example of this in the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.tabularfusion.concat_data.html#fusilli.fusionmodels.tabularfusion.concat_data.ConcatTabularData" title="fusilli.fusionmodels.tabularfusion.concat_data.ConcatTabularData"><code class="xref py py-class docutils literal notranslate"><span class="pre">ConcatTabularData</span></code></a> class.</p></li>
<li><p>You can create your own layers. This is the most flexible way to create your own fusion model but it might mean that the model is less easily comparible to other models in the library.</p></li>
</ol>
<p>Let’s go through each of these methods in turn.</p>
<p><strong>Method 1: Using preset layers</strong></p>
<p>Let’s say we want to use the preset layers in the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class. We can do this by calling the following functions:</p>
<ul class="simple">
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">set_mod1_layers()</span></code> : sets the layers for the first tabular modality as <code class="docutils literal notranslate"><span class="pre">self.mod1_layers</span></code>.</p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">set_mod2_layers()</span></code> : sets the layers for the second tabular modality as <code class="docutils literal notranslate"><span class="pre">self.mod2_layers</span></code>.</p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">set_img_layers()</span></code> : sets the layers for the image modality as <code class="docutils literal notranslate"><span class="pre">self.img_layers</span></code>.</p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">set_fused_layers()</span></code> : sets some layers that take place after the fusion of the modalities (may not be applicable for all fusion models) as <code class="docutils literal notranslate"><span class="pre">self.fused_layers</span></code>. For example, if you’re concatenating feature maps from multiple modalities, the fused layers would be the layers after the concatenation and before the prediction.</p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">set_final_pred_layers()</span></code> : sets the layers for the final prediction as <code class="docutils literal notranslate"><span class="pre">self.final_predction</span></code>. We must set <code class="docutils literal notranslate"><span class="pre">self.pred_type</span></code> to the <code class="docutils literal notranslate"><span class="pre">pred_type</span></code> input argument of the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function before calling this function. This is because the final prediction layers depend on the type of prediction we want to perform.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">self.set_mod1_layers()</span></code> by itself is equivalent to calling <code class="docutils literal notranslate"><span class="pre">self.mod1_layers</span> <span class="pre">=</span> <span class="pre">self.set_mod1_layers()</span></code>. This is because the <code class="docutils literal notranslate"><span class="pre">set_mod1_layers()</span></code> function assigns the layers to the <code class="docutils literal notranslate"><span class="pre">mod1_layers</span></code> attribute in <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a>, which our model inherits from.
The same is true for the other <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> functions: <code class="docutils literal notranslate"><span class="pre">set_mod2_layers()</span></code>, <code class="docutils literal notranslate"><span class="pre">set_img_layers()</span></code>, <code class="docutils literal notranslate"><span class="pre">set_fused_layers()</span></code>, and <code class="docutils literal notranslate"><span class="pre">set_final_pred_layers()</span></code>.</p>
</div>
<p><strong>Method 2: Creating your own layers</strong></p>
<p>This is simply done by creating a dictionary of layers and assigning it to the <code class="docutils literal notranslate"><span class="pre">mod1_layers</span></code> attribute of the model. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span>
    <span class="s2">&quot;linear1&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="s2">&quot;linear2&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="s2">&quot;linear3&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Let’s create our own layers for our model. We’ll use the preset layers in the <a class="reference internal" href="../autosummary/fusilli.fusionmodels.base_model.html#fusilli.fusionmodels.base_model.ParentFusionModel" title="fusilli.fusionmodels.base_model.ParentFusionModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParentFusionModel</span></code></a> class and make a tabular-tabular fusion model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># str: name of the method</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template fusion model&quot;</span>
    <span class="c1"># str: modality type</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>  <span class="c1"># or &quot;tabular1&quot;, &quot;tabular2&quot;, &quot;both_tab&quot;, &quot;tab_img&quot;, &quot;img&quot;</span>
    <span class="c1"># str: fusion type</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;attention&quot;</span>  <span class="c1"># or &quot;operation&quot;, &quot;tensor&quot;, &quot;graph&quot;, &quot;subspace&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">=</span> <span class="n">pred_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod1_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the first tabular modality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod2_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the second tabular modality</span>

        <span class="c1"># Calculate the &quot;fused_dim&quot;: how many features are there after the fusion? For example:</span>
        <span class="n">mod1_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="n">mod2_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">mod1_layers_output_dim</span> <span class="o">+</span> <span class="n">mod2_layers_output_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_fused_layers</span><span class="p">(</span>
            <span class="n">fused_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span><span class="p">)</span>  <span class="c1"># set the fused layers with an input dimension of self.fused_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_pred_layers</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>  <span class="c1"># set the final prediction layers with an input dimension of 64 (output dimension of fused layers)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
</section>
<section id="step-3-setting-up-model-to-be-modifiable">
<h2>Step 3: Setting up model to be modifiable<a class="headerlink" href="#step-3-setting-up-model-to-be-modifiable" title="Permalink to this heading"></a></h2>
<p>Great! We’ve set up the model structure. Now we need to make sure that the model is modifiable.</p>
<p>In order to do this, we need to make sure that the model can handle if parts of it are changed.
For example, if the number of output nodes in the final layers of <code class="docutils literal notranslate"><span class="pre">self.mod1_layers</span></code> is changed,
the layers after it have to be recalculated so that there isn’t a dimension mismatch.</p>
<p>We can do this by creating a function called <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code>. This function should be called at the end of the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function and should
contain all the checks that need to be performed to make sure that the modifications made to the model are valid.
The function <code class="docutils literal notranslate"><span class="pre">set_final_pred_layers()</span></code> should be moved into this function since it relies on the outputs of modifiable layers before it.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This function must be called <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code>.
This is because the function is called whenever a modification is made to the model in <a class="reference internal" href="../autosummary/fusilli.utils.model_modifier.html#fusilli.utils.model_modifier.modify_model_architecture" title="fusilli.utils.model_modifier.modify_model_architecture"><code class="xref py py-func docutils literal notranslate"><span class="pre">modify_model_architecture()</span></code></a>.</p>
<p>If you call the function something else, it won’t be called when a modification is made to the model and the model won’t be modifiable.</p>
</div>
<p><strong>The steps we are taking here are:</strong></p>
<ol class="arabic simple">
<li><p>Create a function called <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code>.</p></li>
<li><p>Recalculate <code class="docutils literal notranslate"><span class="pre">self.fused_dim</span></code> in the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function to update the fused dimension if the model is modified.</p></li>
<li><p>Add a check in the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function with <a class="reference internal" href="../autosummary/fusilli.utils.check_model_validity.html#fusilli.utils.check_model_validity.check_fused_layers" title="fusilli.utils.check_model_validity.check_fused_layers"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_fused_layers()</span></code></a> to make sure that the fused layers are valid. This changes the first fused layer to have the correct input dimension (if it’s not already correct) and outputs the output dimension of the fused layers.</p></li>
<li><p>Move the <code class="docutils literal notranslate"><span class="pre">set_final_pred_layers()</span></code> function into the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function and use the input from the fused layers to set the final prediction layers.</p></li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function at the end of the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If calculating <code class="docutils literal notranslate"><span class="pre">self.fused_dim</span></code> is complicated, you can create a separate function called <code class="docutils literal notranslate"><span class="pre">get_fused_dim()</span></code> and call it in <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> and in <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code>.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># str: name of the method</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template fusion model&quot;</span>
    <span class="c1"># str: modality type</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>  <span class="c1"># or &quot;tabular1&quot;, &quot;tabular2&quot;, &quot;both_tab&quot;, &quot;tab_img&quot;, &quot;img&quot;</span>
    <span class="c1"># str: fusion type</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;attention&quot;</span>  <span class="c1"># or &quot;operation&quot;, &quot;tensor&quot;, &quot;graph&quot;, &quot;subspace&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">=</span> <span class="n">pred_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod1_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the first tabular modality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod2_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the second tabular modality</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_fused_dim</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_fused_layers</span><span class="p">(</span>
            <span class="n">fused_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span><span class="p">)</span>  <span class="c1"># set the fused layers with an input dimension of self.fused_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calc_fused_layers</span><span class="p">()</span>  <span class="c1"># calculate the fused layers to make sure there aren&#39;t dimension mismatches</span>

    <span class="k">def</span> <span class="nf">get_fused_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mod1_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="n">mod2_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">mod1_layers_output_dim</span> <span class="o">+</span> <span class="n">mod2_layers_output_dim</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc_fused_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_fused_dim</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">,</span> <span class="n">out_dim</span> <span class="o">=</span> <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_fused_layers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_pred_layers</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">out_dim</span><span class="p">)</span>  <span class="c1"># set the final prediction layers with the output dimension of fused layers</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="step-4-defining-the-forward-function">
<h2>Step 4: Defining the forward function<a class="headerlink" href="#step-4-defining-the-forward-function" title="Permalink to this heading"></a></h2>
<p>Let’s define the forward function of our model. This is where we define how the data flows through the model. This example is concatenating the feature maps of two tabular modalities.</p>
<p><strong>The input into the forward function is either:</strong></p>
<ul class="simple">
<li><p>a tuple of tensors (modality1, modality2) if there are two modalities</p></li>
<li><p>a tensor of the original input data (if there is only one modality). This is probably not applicable to your model but it might be for a graph- or subspace-based fusion model.</p></li>
</ul>
<p><strong>The output of the forward function is a list containing the output of the model.</strong>
This is because some of the models in <code class="docutils literal notranslate"><span class="pre">fusilli</span></code> output reconstructed data as well as the prediction, and this library is designed to handle this by all outputs either being a list of length 1 or 2.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x_tab1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># tabular1 data</span>
    <span class="n">x_tab2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># tabular2 data</span>

    <span class="c1"># Passing the data through the modality layers</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">x_tab1</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x_tab1</span><span class="p">)</span>
        <span class="n">x_tab2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">x_tab2</span><span class="p">)</span>

    <span class="c1"># Concatenating the feature maps from the two modalities</span>
    <span class="n">out_fuse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_tab1</span><span class="p">,</span> <span class="n">x_tab2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Passing the fused data through the fused layers</span>
    <span class="n">out_fuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">(</span><span class="n">out_fuse</span><span class="p">)</span>

    <span class="c1"># Passing the data through the final prediction layers</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction</span><span class="p">(</span><span class="n">out_fuse</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">out</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
</section>
<section id="step-5-adding-checks">
<h2>Step 5: Adding checks<a class="headerlink" href="#step-5-adding-checks" title="Permalink to this heading"></a></h2>
<p>Let’s add some checks to make sure that the model components and the input data are what we expect them to be.
We’ve already added checks to the <code class="docutils literal notranslate"><span class="pre">self.fused_layers</span></code> attribute in the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function.
<strong>The checks we are adding are:</strong></p>
<ul class="simple">
<li><p>Checking that the input data is a tuple of tensors with <a class="reference internal" href="../autosummary/fusilli.utils.check_model_validity.html#fusilli.utils.check_model_validity.check_model_input" title="fusilli.utils.check_model_validity.check_model_input"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_model_input()</span></code></a>.</p></li>
<li><p>Checking that the modality layers are a <code class="xref py py-class docutils literal notranslate"><span class="pre">ModuleDict</span></code> with <a class="reference internal" href="../autosummary/fusilli.utils.check_model_validity.html#fusilli.utils.check_model_validity.check_dtype" title="fusilli.utils.check_model_validity.check_dtype"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_dtype()</span></code></a>.</p></li>
</ul>
<p>Your model might have more specific checks, such as checking that your modality layers have the same number of layers if that is a requirement of your model.</p>
<p>At the beginning of the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> function, we add the following check:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_model_input</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># rest of forward function</span>
</pre></div>
</div>
<p>At the beginning of the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function, we add the following checks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_fused_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">,</span> <span class="s2">&quot;mod1_layers&quot;</span><span class="p">)</span>
    <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">,</span> <span class="s2">&quot;mod2_layers&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If we were using images, we would also add the following check at the beginning of the <code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code> function which checks that the image layers are a <code class="xref py py-class docutils literal notranslate"><span class="pre">ModuleDict</span></code> and that the image dimension is correct</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_fused_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_img_dim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_dim</span><span class="p">,</span> <span class="s2">&quot;img_layers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-6-adding-documentation">
<h2>Step 6: Adding documentation<a class="headerlink" href="#step-6-adding-documentation" title="Permalink to this heading"></a></h2>
<p>All that’s left is to add documentation to the model. This is done by adding a docstring to the class and to the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function.
The docstring for the class should contain the following:</p>
<ul class="simple">
<li><p>A description of the model.</p></li>
<li><p>The attributes of the model (all the attributes that start with <code class="docutils literal notranslate"><span class="pre">self.</span></code>).</p></li>
</ul>
<p>The docstring for the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function and other functions in the model (<code class="docutils literal notranslate"><span class="pre">calc_fused_layers()</span></code>, etc)should contain the following:</p>
<ul class="simple">
<li><p>A description of the function.</p></li>
<li><p>The input arguments of the function.</p></li>
<li><p>The output of the function.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The docstrings are formatted in a specific way so that they can be documented automatically by Sphinx.</p>
</div>
<p>Let’s add documentation to our model and see it all come together!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateFusionModel</span><span class="p">(</span><span class="n">ParentFusionModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Description of the model.</span>

<span class="sd">    More information about the model, perhaps a link to a paper, etc.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    method_name : str</span>
<span class="sd">        Name of the method.</span>
<span class="sd">    modality_type : str</span>
<span class="sd">        Type of modality.</span>
<span class="sd">    fusion_type : str</span>
<span class="sd">        Type of fusion.</span>
<span class="sd">    pred_type : str</span>
<span class="sd">        Type of prediction to be performed.</span>
<span class="sd">    mod1_layers : dict</span>
<span class="sd">        Dictionary containing the layers of the first modality.</span>
<span class="sd">    mod2_layers : dict</span>
<span class="sd">        Dictionary containing the layers of the second modality.</span>
<span class="sd">    fused_dim : int</span>
<span class="sd">        Dimension of the fused layers.</span>
<span class="sd">    fused_layers : nn.Sequential</span>
<span class="sd">        Sequential layer containing the fused layers.</span>
<span class="sd">    final_prediction : nn.Sequential</span>
<span class="sd">        Sequential layer containing the final prediction layers. The final prediction layers</span>
<span class="sd">        take in the number of features of the fused layers as input.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># str: name of the method</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;Template fusion model&quot;</span>
    <span class="c1"># str: modality type</span>
    <span class="n">modality_type</span> <span class="o">=</span> <span class="s2">&quot;both_tab&quot;</span>  <span class="c1"># or &quot;tabular1&quot;, &quot;tabular2&quot;, &quot;both_tab&quot;, &quot;tab_img&quot;, &quot;img&quot;</span>
    <span class="c1"># str: fusion type</span>
    <span class="n">fusion_type</span> <span class="o">=</span> <span class="s2">&quot;attention&quot;</span>  <span class="c1"># or &quot;operation&quot;, &quot;tensor&quot;, &quot;graph&quot;, &quot;subspace&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialising the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        pred_type : str</span>
<span class="sd">            Type of prediction to be performed.</span>
<span class="sd">        data_dims : list</span>
<span class="sd">            List containing the dimensions of the data. This is calculated by :func:`~fusilli.data.get_data_module`.</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary containing the parameters of the model. This is specified by the user in their python script or notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ParentFusionModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_type</span><span class="p">,</span> <span class="n">data_dims</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_type</span> <span class="o">=</span> <span class="n">pred_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod1_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the first tabular modality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mod2_layers</span><span class="p">()</span>  <span class="c1"># set the layers for the second tabular modality</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_fused_dim</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_fused_layers</span><span class="p">(</span>
            <span class="n">fused_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span><span class="p">)</span>  <span class="c1"># set the fused layers with an input dimension of self.fused_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calc_fused_layers</span><span class="p">()</span>  <span class="c1"># calculate the fused layers to make sure there aren&#39;t dimension mismatches</span>

    <span class="k">def</span> <span class="nf">get_fused_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of input features of the fused layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mod1_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="n">mod2_layers_output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">out_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">mod1_layers_output_dim</span> <span class="o">+</span> <span class="n">mod2_layers_output_dim</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc_fused_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the fused layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">,</span> <span class="s2">&quot;mod1_layers&quot;</span><span class="p">)</span>
        <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">,</span> <span class="s2">&quot;mod2_layers&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_fused_dim</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">,</span> <span class="n">out_dim</span> <span class="o">=</span> <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_fused_layers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fused_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_pred_layers</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">out_dim</span><span class="p">)</span>  <span class="c1"># set the final prediction layers with the output dimension of fused layers</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : tuple</span>
<span class="sd">         Tuple containing the input data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">         List containing the output of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_model_validity</span><span class="o">.</span><span class="n">check_model_input</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x_tab1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># tabular1 data</span>
        <span class="n">x_tab2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># tabular2 data</span>

        <span class="c1"># Passing the data through the modality layers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod1_layers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">x_tab1</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x_tab1</span><span class="p">)</span>
            <span class="n">x_tab2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod2_layers</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">x_tab2</span><span class="p">)</span>

        <span class="c1"># Concatenating the feature maps from the two modalities</span>
        <span class="n">out_fuse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_tab1</span><span class="p">,</span> <span class="n">x_tab2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Passing the fused data through the fused layers</span>
        <span class="n">out_fuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fused_layers</span><span class="p">(</span><span class="n">out_fuse</span><span class="p">)</span>

        <span class="c1"># Passing the data through the final prediction layers</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction</span><span class="p">(</span><span class="n">out_fuse</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">out</span><span class="p">,</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>I hope this template has been helpful! If you have any questions, please feel free to ask in the GitHub Discussions page.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-contributing-examples-template-other-fusion-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4726f6481503b6daca93b325caf40c7b/template_other_fusion.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">template_other_fusion.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/dce3afe1d694a29cb64113649a549a5f/template_other_fusion.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">template_other_fusion.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Florence J Townend.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>